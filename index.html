
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í•˜ë°ìŠ¤ í‚¤ìš°ê¸° v23.7 (Chart Competition)</title>
    <style>
        :root { --bg: #f5f7fa; --card: #ffffff; --point: #ff4d94; --text: #333; --border: #e1e4e8; --success: #40c057; --vocal: #ff4d94; --dance: #ae3ec9; --visual: #4dadff; --variety: #fab005; --charm: #f06595; --money: #2b8a3e; --danger: #fa5252; --sns: #405de6; --yt: #ff0000; --yz: #000000; --subak: #0ca678; --musicside: #1c7ed6; --tube: #f03e3e; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; margin: 0; padding: 0; line-height: 1.5; overflow-x: hidden; }
        
        /* ì‹œì‘ & ë„¤ë¹„ */
        #start-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; text-align: center; }
        .start-logo { font-size: 3rem; font-weight: 900; color: var(--point); margin-bottom: 10px; text-shadow: 0 0 20px rgba(255,77,148,0.5); }
        .start-btn { padding: 18px 60px; background: var(--point); color: white; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(255,77,148,0.3); transition: 0.3s; }
        .start-btn:hover { transform: scale(1.05); }
        .nav-bar { display: none; background: white; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; padding: 15px 5px; border: none; background: transparent; color: #666; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; white-space: nowrap; }
        .nav-btn.active { color: var(--point); border-bottom: 3px solid var(--point); background: #fffafc; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .container { display: none; max-width: 900px; margin: 0 auto; padding: 15px 15px 100px 15px; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; }
        .date-display { position: relative; text-align: right; margin-bottom: 10px; }
        @media (min-width: 600px) { .date-display { position: absolute; top: 15px; right: 25px; } }
        .day-count { font-weight: bold; color: var(--point); font-size: 18px; display: block; }
        .real-date { font-size: 12px; color: #888; }
        h2 { color: #222; font-size: 1.1rem; margin-top: 0; border-left: 4px solid var(--point); padding-left: 10px; margin-bottom: 15px; }
        .money-text { color: var(--money); font-weight: bold; }
        
        /* ìŠ¤íƒ¯ */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .stat-item small { color: #777; font-size: 11px; }
        .stat-item strong { font-size: 15px; display: block; margin-top: 2px; }

        /* ì°¨íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ */
        .chart-tabs { display: flex; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .chart-tab-btn { flex: 1; border: none; background: #f1f3f5; padding: 10px; cursor: pointer; font-size: 13px; font-weight: bold; color: #888; transition: 0.2s; }
        .chart-tab-btn.active { background: white; color: #333; }
        .chart-tab-btn.subak.active { color: var(--subak); border-bottom: 2px solid var(--subak); }
        .chart-tab-btn.musicside.active { color: var(--musicside); border-bottom: 2px solid var(--musicside); }
        .chart-tab-btn.tube.active { color: var(--tube); border-bottom: 2px solid var(--tube); }
        
        .chart-list { min-height: 300px; }
        .chart-row { display: flex; align-items: center; padding: 10px 5px; border-bottom: 1px solid #f1f3f5; font-size: 13px; }
        .chart-row:nth-child(1) .rank { color: #ffd43b; text-shadow: 1px 1px 0 #e67700; font-size: 16px; }
        .chart-row:nth-child(2) .rank { color: #adb5bd; font-size: 15px; }
        .chart-row:nth-child(3) .rank { color: #e599f7; font-size: 15px; }
        .chart-row.my-song { background: #fff0f6; border-radius: 8px; border: 1px solid #fcc2d7; }
        
        .rank { width: 30px; font-weight: 900; text-align: center; margin-right: 10px; color: #495057; }
        .rank-change { width: 20px; font-size: 10px; text-align: center; margin-right: 10px; color: #888; }
        .rank-up { color: var(--danger); }
        .rank-down { color: #1c7ed6; }
        .song-info { flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .song-title { font-weight: bold; display: block; }
        .artist-name { font-size: 11px; color: #888; }
        .chart-score { font-size: 10px; color: #adb5bd; text-align: right; width: 40px; }

        /* ì»¤ë®¤ë‹ˆí‹° */
        .comm-post { border-bottom: 1px solid #eee; padding: 10px 0; }
        .comm-site { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
        .site-ebem { background: #e7f5ff; color: #1971c2; }
        .site-cafe { background: #fff0f6; color: #d6336c; }
        .site-sns { background: #f0f1ff; color: var(--sns); }
        .site-yt { background: #ffe3e3; color: var(--yt); }
        .site-yz { background: #000; color: #fff; }
        .site-news { background: #343a40; color: #fff; }
        .site-music { background: #e6fcf5; color: #0ca678; }
        #comm-container { max-height: 240px; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; }
        
        /* ë©¤ë²„ & ì»¨í…ì¸  */
        .member-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 650px) { .member-grid { grid-template-columns: repeat(2, 1fr); } }
        .member-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; position: relative; transition: 0.3s; }
        .member-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .profile-container { display: flex; align-items: center; margin-bottom: 15px; }
        .profile-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); margin-right: 12px; background: #eee; }
        .profile-info { flex: 1; }
        .stat-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 12px; }
        .stat-label { width: 40px; color: #777; font-size: 11px; }
        .stat-bar-bg { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 0 8px; }
        .stat-bar-fill { height: 100%; border-radius: 4px; transition: 0.5s; }
        .bonus-stat { color: var(--success); font-weight: bold; font-size: 10px; margin-left: 4px; }
        .equip-btn { position: absolute; top: 15px; right: 15px; padding: 5px 10px; background: #333; color: white; font-size: 11px; border-radius: 5px; border:none; cursor: pointer; }
        .equipped-items { margin-top: 10px; font-size: 11px; color: #666; background: #f8f9fa; padding: 8px; border-radius: 6px; min-height: 20px;}
        .enhance-text { color: #845ef7; font-weight: bold; }

        .content-card { border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 12px; background: #fff; transition:0.2s; position: relative; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .content-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-short { background: #e3fafc; color: #0c8599; }
        .badge-mid { background: #f3f0ff; color: #6741d9; }
        .badge-long { background: #fff0f6; color: #c2255c; }
        .badge-item { background: #f3f0ff; color: #5c7cfa; }
        .badge-special { background: #fff5f5; color: #ff0000; border: 1px solid #ffc9c9; }
        .content-info { font-size: 12px; color: #555; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .content-btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-available { background: var(--point); box-shadow: 0 4px 6px rgba(255, 77, 148, 0.2); }
        .btn-available:hover { filter: brightness(0.9); }
        .btn-cooldown { background: #adb5bd; cursor: not-allowed; }
        .risk-high { color: #fa5252; font-weight: bold; }
        
        /* ë²„íŠ¼ & ëª¨ë‹¬ */
        .next-day-bar { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 12px; border-top: 1px solid var(--border); text-align: center; z-index: 100; box-sizing: border-box; }
        .primary-btn { width: 100%; padding: 14px; background: var(--point); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; transition:0.2s; }
        .primary-btn:hover { background: #e64980; }
        .primary-btn:disabled { background: #adb5bd; cursor: not-allowed; }
        .choice-btn { width: 100%; padding: 14px; background: #f1f3f5; color: #333; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; margin-bottom: 8px; text-align: left; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition:0.2s; }
        .choice-btn:hover { background: #e9ecef; }
        .upgrade-btn { padding: 4px 8px; font-size: 11px; background: #7950f2; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:5px; font-weight:bold; }
        .upgrade-btn:disabled { background: #ccc; cursor: not-allowed; }
        .modal-overlay { display: none; position: fixed; z-index: 9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
        .modal-content { background:white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding:25px; width: 85%; max-width:400px; border-radius:20px; text-align:center; box-sizing: border-box; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .half-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .save-load-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .save-btn { background: #495057; color: white; padding: 10px; border-radius: 8px; border: none; font-size: 12px; cursor: pointer; }
        
        /* ì‹œì¦Œ í‹°ì–´ */
        .tier-badge { font-size: 16px; font-weight: 900; margin: 10px 0; display: inline-block; padding: 8px 20px; border-radius: 50px; color:white; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .tier-rookie { background: #ced4da; color: #495057; }
        .tier-rising { background: #74c0fc; }
        .tier-domestic { background: #40c057; }
        .tier-asia { background: #fab005; }
        .tier-na { background: #e64980; }
        .tier-world { background: linear-gradient(45deg, #a5d8ff, #7950f2, #ff8787); box-shadow: 0 0 15px rgba(121, 80, 242, 0.5); position: relative; overflow: hidden; }
        .tier-world::after { content:''; position: absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shine 2s infinite; }
        @keyframes shine { 100% { left: 100%; } }
    </style>
</head>
<body>

<div id="start-page">
    <div class="start-logo">HADES</div>
    <div class="start-sub">Virtual Idol Management v23.7</div>
    <button class="start-btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
</div>

<div class="nav-bar" id="main-nav">
    <button class="nav-btn active" onclick="openPage('home', this)">ğŸ“Š í™ˆ</button>
    <button class="nav-btn" onclick="openPage('members', this)">ğŸ‘¥ ë©¤ë²„</button>
    <button class="nav-btn" onclick="openPage('contents', this)">ğŸ¬ ì»¨í…ì¸ </button>
    <button class="nav-btn" onclick="openPage('store', this)">ğŸ›ï¸ ìƒì </button>
    <button class="nav-btn" onclick="openPage('manual', this)">ğŸ“… ì§€ì‹œ</button>
</div>

<div class="container" id="main-container">
    <div id="home" class="page active">
        <div class="card">
            <div class="date-display">
                <span class="day-count">ìš´ì˜ <span id="current-day">1</span>ì¼ì°¨</span>
                <span class="real-date" id="current-date">2025-09-05</span>
            </div>
            <h2>ìƒíƒœ</h2>
            <div class="stat-grid">
                <div class="stat-item"><small>ë³´ìœ  ìì‚°</small><strong id="p-finance" class="money-text">200,000,000ì›</strong></div>
                <div class="stat-item"><small>íŒ¬ì¹´í˜ íšŒì›</small><strong id="p-fandom">110,000ëª…</strong></div>
                <div class="stat-item"><small>ë„ˆíŠœë¸Œ êµ¬ë…</small><strong id="p-youtube">20,000ëª…</strong></div>
                <div class="stat-item"><small>SNS íŒ”ë¡œì›Œ</small><strong id="p-sns">1,000ëª…</strong></div>
                <div class="stat-item"><small>í˜„ì¬ ì¸ì§€ë„</small><strong id="p-tier" style="color:#7950f2;">ë£¨í‚¤</strong></div>
                <div class="stat-item"><small>ëˆ„ì  ë§¤ì¶œ</small><strong id="p-sales">0ì›</strong></div>
            </div>
        </div>

        <!-- NEW: í†µí•© ì°¨íŠ¸ -->
        <div class="card">
            <h2>ğŸ† ì‹¤ì‹œê°„ í†µí•© ì°¨íŠ¸</h2>
            <div class="chart-tabs">
                <button class="chart-tab-btn subak active" onclick="switchChartTab('subak')">ğŸˆ ìˆ˜ë°•</button>
                <button class="chart-tab-btn musicside" onclick="switchChartTab('musicside')">ğŸ’¿ ë®¤ì§ì‚¬ì´ë“œ</button>
                <button class="chart-tab-btn tube" onclick="switchChartTab('tube')">ğŸ“º ë„ˆíŠœë¸Œ</button>
            </div>
            <div id="chart-list-container" class="chart-list"></div>
            <div style="font-size:11px; text-align:center; color:#adb5bd; margin-top:10px;">* ë§¤ì¼ 00ì‹œ ìˆœìœ„ ì—…ë°ì´íŠ¸ (1~10ìœ„ í‘œì‹œ)</div>
        </div>

        <div class="half-grid">
            <div class="card" id="profit-report" style="display:none; background: #f2fcf0; border-color: #40c057;">
                <h2>ğŸˆ ì¼ì¼ ë¦¬í¬íŠ¸</h2>
                <div id="profit-content" style="font-size: 14px;"></div>
            </div>
            <div class="card" id="post-section" style="display:block; background: #fff9db; border-color: #fab005;">
                <h2>âœï¸ ì»¤ë®¤ë‹ˆí‹° ê¸€ì‘ì„±</h2>
                <select id="post-site" style="width:100%; padding:5px; margin-bottom:5px; border-radius:5px; border:1px solid #ddd; font-size:12px;">
                    <option value="íŒ¬ì¹´í˜">íŒ¬ì¹´í˜</option>
                    <option value="ì—ë±€">ì—ë²°</option>
                    <option value="YZ">YZ</option>
                </select>
                <input type="text" id="post-input" placeholder="ê¸€ ì…ë ¥..." style="width:100%; padding:8px; border-radius:5px; border:1px solid #ddd; font-size:12px; box-sizing:border-box;">
                <button id="post-submit-btn" class="primary-btn" style="padding:5px; font-size:12px; margin-top:5px; background:#fab005;" onclick="submitPost()">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </div>
        <div class="card">
            <h2>ğŸŒ ì‹¤ì‹œê°„ ë°˜ì‘</h2>
            <div id="comm-container"></div>
        </div>
        <div class="save-load-btns">
            <button class="save-btn" onclick="saveGame()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
            <button class="save-btn" style="background:#212529;" onclick="loadGame()">ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
    </div>

    <div id="members" class="page">
        <div class="member-grid" id="member-grid-container"></div>
    </div>

    <div id="contents" class="page">
        <div class="card">
            <h2>ğŸ”¥ ìŠ¤í˜ì…œ í”„ë¡œì íŠ¸ (í•œì •)</h2>
            <div id="special-content-list"></div>
        </div>
        <div class="card">
            <h2>ğŸ¬ ì¼ë°˜ ì»¨í…ì¸  ì œì‘</h2>
            <div id="content-list"></div>
        </div>
    </div>

    <div id="store" class="page">
        <div class="card">
            <h2>ğŸ›ï¸ ë°©ì†¡ ì¥ë¹„ ìƒì </h2>
            <div id="shop-list"></div>
        </div>
    </div>

    <div id="manual" class="page">
        <div class="card">
            <h2>ìˆ˜ë™ ì§€ì‹œ</h2>
            <select id="sel-member" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;"></select>
            <select id="sel-stat" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
                <option value="vocal">ğŸ¤ ë³´ì»¬ ì§‘ì¤‘ í›ˆë ¨</option>
                <option value="dance">ğŸ’ƒ ì•ˆë¬´ ì—°ìŠµ</option>
                <option value="visual">âœ¨ ë¹„ì£¼ì–¼ ì¼€ì–´</option>
                <option value="variety">ğŸ—£ï¸ ì˜ˆëŠ¥ ìŠ¤í”¼ì¹˜</option>
                <option value="charm">ğŸ€ ë§¤ë ¥ ê°•í™”</option>
                <option value="stream">ğŸ“¡ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</option>
                <option value="rest">ğŸ’¤ ê¿€ê°™ì€ íœ´ì‹</option>
            </select>
            <button class="primary-btn" onclick="manualTrainAction()">ì§€ì‹œ ì™„ë£Œ</button>
        </div>
    </div>
</div>

<div class="next-day-bar" id="main-footer">
    <button class="primary-btn" style="background: #40c057;" onclick="nextDay()">ğŸŒ™ ë‹¤ìŒë‚ ë¡œ (Space)</button>
</div>

<div id="eventModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <div id="modal-body" style="margin: 15px 0; font-size: 14px;"></div>
        <div id="modal-choices"></div>
    </div>
</div>

<script>
    // === ë¼ì´ë²Œ ë°ì´í„° ===
    const rivalArtists = [
        "ì‹œí€€ì„œ", "ë””ì§€ë…¸ë¯¹", "ê¸€ë¦¬ì¹˜ë¬¸", "ë‰´ëŸ´ì›¨ì´ë¸Œ", "ë¹„íŠ¸ì…¸", "ì½”ì–´ë§í¬", "ì‚¬ì´ë²„ë¦¬í”„", "í”½ì…€í—¤ì´ì¦ˆ", "ì‹±í¬ë¹„ì „", "ë²¡í„°ë³´ì´ì¦ˆ",
        "ì•Œê³ ë¦¬ë“¬", "í”Œë¡œíŒ…ì¹©", "ì–¸ë¦¬ì–¼ì†Œìš¸", "ì„œë¸Œë ˆì´ì–´", "ë©”íƒ€ëª¨í”„", "í•˜ì´í¼ë£¨í”„", "ì‹ ìŠ¤í”Œë¡œìš°", "ëˆ„í´ë¦¬ì–´ìŠ¤", "KRYX", "LYNQ",
        "V-ZIT", "X-IEL", "JOYN", "N-ZIA", "RYZE-O", "QUV", "W-AVE", "SYLK", "F-REEL", "G-LOWD", "VEXEN", "TYRO", "Z-EEN",
        "M-NEX", "O-RIT", "P-LEY", "B-ZON", "X-WAY", "H-YDE", "L-UVN", "S-YDE", "A-XIS", "N-TICK", "ëˆ„ë³´", "ë””íŠ¸", "ê¸€ë¦¿",
        "ì˜¤ë¡œ", "ì œë¡œë‹ˆ", "ì‹±í¬", "ë² ì´í¼í”Œë¡œ", "ì—ì´ë“ ", "ë£¨ë¯¸ë„ˆ", "ì½”ë”", "ì„œë¸Œ", "í…”ë ˆ", "ë¦¬ì…‹", "ë¯¸ëŸ¬", "ê³ ìŠ¤íŠ¸"
    ];
    const songSuffixes = ["Theory", "Protocol", "Love", "System", "Night", "Dream", "Code", "Signal", "Wave", "Zone", "Heart", "Drive", "Light", "Shadow", "Echo", "Future"];

    function getRandomSong(artist) {
        return `${artist} - ${songSuffixes[Math.floor(Math.random() * songSuffixes.length)]} ${Math.floor(Math.random()*9)+1}`;
    }

    // === ê²Œì„ ë¡œì§ ===
    function startGame() {
        document.getElementById('start-page').style.display = 'none';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('main-container').style.display = 'block';
        document.getElementById('main-footer').style.display = 'block';
        initRivalCharts(); // ë¼ì´ë²Œ ì°¨íŠ¸ ì´ˆê¸°í™”
        updateDisplay();
        renderHomeCharts('subak'); // ì´ˆê¸° ì°¨íŠ¸ ë Œë”ë§
    }

    function createMember(name, birth, imgId, customStats, customUrl = null) {
        let stats = customStats;
        const mental = Math.floor(Math.random() * 90) + 11; 
        const imageUrl = customUrl ? customUrl : `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;
        return { 
            name, birth, image: imageUrl, 
            vocal: stats.vocal, dance: stats.dance, visual: stats.visual, variety: stats.variety, charm: stats.charm, 
            fatigue: 0, mental: mental, manualAct: null, equipment: [] 
        };
    }

    let gameState = {
        day: 1, startDate: new Date('2025-09-05'), finance: 200000000, fandom: 110000, youtube: 20000, sns: 1000,
        accumulatedSales: 0, 
        currentTier: "ë£¨í‚¤",
        activeCharts: [], // ë‚´ í™œë™ ê³¡ { name, releaseDate, scores: {subak, musicside, tube} }
        rivalCharts: [], // ë¼ì´ë²Œ ê³¡ { artist, title, scores: {subak, musicside, tube} }
        flags: { albumPaid: false, concertBought: false, concertDone: false },
        currentChartTab: 'subak',
        members: [
            createMember('í‚¤ë§ˆ', '04-22', 1, {vocal:8, dance:3, visual:3, variety:3, charm:3}, 'https://cdnimg.melon.co.kr/cm2/photo/images/000/803/29/513/80329513_20260120180131_org.jpg/melon/quality/80/optimize'), 
            createMember('ëµê·¤', '12-24', 2, {vocal:7, dance:3, visual:3, variety:4, charm:3}, 'https://cdnimg.melon.co.kr/cm2/photo/images/000/803/26/813/80326813_20251224160243_org.jpg/melon/quality/80/optimize'), 
            createMember('ì±ˆë‚˜', '02-26', 3, {vocal:2, dance:5, visual:9, variety:2, charm:2}, 'https://cdnimg.melon.co.kr/cm2/photo/images/000/803/26/812/80326812_20251224160127_org.jpg/melon/quality/80/optimize'),
            createMember('ì†œì£¼ë¨¹', '11-11', 4, {vocal:2, dance:2, visual:3, variety:9, charm:4}, 'https://cdnimg.melon.co.kr/cm2/photo/images/000/803/26/815/80326815_20251224160500_org.jpg/melon/quality/80/optimize'), 
            createMember('ì—°ì´ˆë¡', '03-26', 5, {vocal:7, dance:2, visual:5, variety:2, charm:4}, 'https://cdnimg.melon.co.kr/cm2/photo/images/000/803/26/814/80326814_20251224160415_org.jpg/melon/quality/80/optimize'),
        ],
        community: [], popupQueue: [], weeklyStats: [], pendingPost: null, hasPostedThisWeek: false,
        lastContents: { short: -999, mid: -999, long: -999 },
        inventory: []
    };

    // ì°¨íŠ¸ ì´ˆê¸°í™” (ë¼ì´ë²Œ ìƒì„±)
    function initRivalCharts() {
        if (gameState.rivalCharts.length > 0) return;
        // 30ê°œì˜ ë¼ì´ë²Œ ê³¡ ìƒì„±
        for(let i=0; i<30; i++) {
            const artist = rivalArtists[Math.floor(Math.random() * rivalArtists.length)];
            const title = getRandomSong(artist);
            // ì´ˆê¸° ì ìˆ˜ ëœë¤ ë°°ì • (500 ~ 10000)
            gameState.rivalCharts.push({
                artist: artist,
                title: title,
                scores: {
                    subak: Math.floor(Math.random() * 9500) + 500,
                    musicside: Math.floor(Math.random() * 9500) + 500,
                    tube: Math.floor(Math.random() * 9500) + 500
                },
                prevRanks: { subak: 0, musicside: 0, tube: 0 } // ì´ì „ ìˆœìœ„ ì €ì¥ìš©
            });
        }
        updateChartRanks(); // ì´ˆê¸° ìˆœìœ„ ê³„ì‚°
    }

    const shopItems = [
        { id: 'mic_1', name: 'USB ë§ˆì´í¬', price: 300000, stat: 'vocal', val: 1, desc: 'ê°€ì„±ë¹„ ë§ˆì´í¬ (ë³´ì»¬+1)' },
        { id: 'cam_1', name: 'FHD ì›¹ìº ', price: 500000, stat: 'visual', val: 1, desc: 'ê¸°ë³¸ ìº  (ë¹„ì£¼ì–¼+1)' },
        { id: 'light_1', name: 'ë°©ì†¡ìš© ì¡°ëª…', price: 800000, stat: 'charm', val: 1, desc: 'í™”ì‚¬í•œ ì¡°ëª… (ë§¤ë ¥+1)' },
        { id: 'mic_2', name: 'ì½˜ë´ì„œ ë§ˆì´í¬', price: 2000000, stat: 'vocal', val: 1, desc: 'ê¹”ë”í•œ ìŒì§ˆ (ë³´ì»¬+1)' },
        { id: 'cpu_1', name: 'ë°©ì†¡ ì†¡ì¶œì»´', price: 2500000, stat: 'variety', val: 1, desc: 'ë ‰ ì—†ëŠ” ë°©ì†¡ (ì˜ˆëŠ¥+1)' },
        { id: 'tracker_1', name: 'ë³´ê¸‰í˜• íŠ¸ë˜ì»¤', price: 3000000, stat: 'dance', val: 1, desc: 'ê¸°ë³¸ì ì¸ ì›€ì§ì„ (ëŒ„ìŠ¤+1)' }
    ];

    const contentTypes = {
        short: { id: 'short', name: 'ì»¤ë²„ê³¡ / ìˆì¸  ì±Œë¦°ì§€', type: 'ë‹¨ê¸°', badge: 'badge-short', cooldown: 14, cost: 2000000, risk: 10, desc: 'íŠ¸ë Œë“œë¥¼ ë”°ë¼ê°€ëŠ” ê°€ë²¼ìš´ ì»¨í…ì¸ ', rewardMin: 1500, rewardMax: 3000 },
        mid: { id: 'mid', name: 'í•©ë™ ëª¨ì…˜ìº¡ì³ ê¸°íš', type: 'ì¤‘ê¸°', badge: 'badge-mid', cooldown: 30, cost: 15000000, risk: 20, desc: 'íƒ€ ê¸°ì—…ì„¸/ê°œì¸ì„¸ì™€ ê¸°ìˆ  ì œíœ´ í•©ë°©', rewardMin: 8000, rewardMax: 15000 },
        long: { id: 'long', name: 'ì‹±ê¸€ ë°œë§¤ / ë‹¨ë… ì½˜ì„œíŠ¸', type: 'ì¥ê¸°', badge: 'badge-long', cooldown: 90, cost: 50000000, risk: 30, desc: 'ê·¸ë£¹ì˜ ì‚¬í™œì„ ê±´ ëŒ€í˜• í”„ë¡œì íŠ¸', rewardMin: 40000, rewardMax: 80000 }
    };

    const newsHeadlines = ["ë²„ì¶”ì–¼ ì‹œì¥ ê¸‰ì„±ì¥", "ëŒ€ê¸°ì—…, ë²„ì¶”ì–¼ ì§„ì¶œ", "MZì„¸ëŒ€ ì¥ë˜í¬ë§ 1ìœ„ í¬ë¦¬ì—ì´í„°", "ìŒë°©ì— ë²„ì¶”ì–¼ ë“±ì¥", "8K ëª¨ì…˜ìº¡ì³ ì‹œëŒ€", "ìœ ëª… ì‘ê³¡ê°€ ë²„ì¶”ì–¼ í˜‘ì—… í¬ë§", "K-POP ë‹¤ìŒì€ V-POP?", "ë²„ì¶”ì–¼ êµ¿ì¦ˆ í’ˆê·€", "ì •ë¶€ í¬ë¦¬ì—ì´í„° ì§€ì›", "ë©”íƒ€ë²„ìŠ¤ ì½˜ì„œíŠ¸ ì¸ê¸°"];
    const musicReactions = ["ì´ë²ˆ ë…¸ë˜ í¸ì˜ì ì—ì„œ ê³„ì† ë‚˜ì˜´ ã…‹ã…‹", "TV ê´‘ê³  ë³´ëŠ”ë° í•˜ë°ìŠ¤ ë…¸ë˜ ë‚˜ì™€ì„œ ê¹œë†€", "í›„ë ´êµ¬ ì§„ì§œ ì¤‘ë…ì„± ë¯¸ì³¤ë‹¤", "ê¸¸ê±°ë¦¬ ì§€ë‚˜ê°€ëŠ”ë° ì´ ë…¸ë˜ ë“¤ë¦¼", "ìˆ˜ëŠ¥ ê¸ˆì§€ê³¡ í™•ì •"];
    const upgradeConfig = { 0: { chance: 0.8, costMult: 0.3 }, 1: { chance: 0.5, costMult: 0.6 }, 2: { chance: 0.3, costMult: 1.0 } };
    
    const tierOrder = ["UNRANKED", "ë£¨í‚¤", "ë¼ì´ì§•ìŠ¤íƒ€", "êµ­ë‚´ì—ì„œ ì•Œë ¤ì§", "ì•„ì‹œì•„ì—ì„œ ì•Œë ¤ì§", "ë¶ë¯¸ì—ì„œ ì•Œë ¤ì§", "ì „ì„¸ê³„ì—ì„œ ì•Œë ¤ì§"];

    function saveGame() { localStorage.setItem('hades_save_v23', JSON.stringify(gameState)); alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
    function loadGame() { 
        const saved = localStorage.getItem('hades_save_v23'); 
        if (!saved) return alert("ë°ì´í„° ì—†ìŒ"); 
        const loaded = JSON.parse(saved);
        loaded.members.forEach((m, i) => { 
            if(!m.equipment) m.equipment = []; 
            if(!m.mental) m.mental = Math.floor(Math.random() * 90) + 11;
            if(!m.image) m.image = `https://api.dicebear.com/7.x/avataaars/svg?seed=${m.name}`;
            m.equipment.forEach(e => { if(e.level === undefined) e.level = 0; });
        });
        if(!loaded.inventory) loaded.inventory = [];
        if(loaded.accumulatedSales === undefined) loaded.accumulatedSales = 0;
        if(!loaded.flags) loaded.flags = { albumPaid: false, concertBought: false, concertDone: false };
        if(!loaded.activeCharts) loaded.activeCharts = [];
        if(!loaded.rivalCharts) { loaded.rivalCharts = []; initRivalCharts(); } // êµ¬ë²„ì „ í˜¸í™˜

        gameState = loaded; gameState.startDate = new Date(gameState.startDate); 
        
        const score = calculateTierScore();
        const rankInfo = getTierInfo(score);
        gameState.currentTier = rankInfo.name;

        updateDisplay(); alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ"); 
    }

    const ebemMsgs = ["í•˜ë°ìŠ¤ ì–˜ë„¤ëŠ” ì§„ì§œ ëª¨ë¸ë§ í€„ë¦¬í‹°ê°€ ë³¼ ë•Œë§ˆë‹¤ ê°íƒ„ ë‚˜ì˜¤ë„¤.", "í‚¤ë§ˆ ì˜¤ëŠ˜ ê³ ìŒ ëš«ë¦¬ëŠ” ê±° ë³´ë‹ˆê¹Œ ëª© ìƒíƒœ ìµœìƒì¸ ë“¯?", "ëµê·¤ ë°©ì†¡ ê°ê°ì€ ì§„ì§œ íƒ€ê³ ë‚¬ë‹¤. ì˜¤ë””ì˜¤ ì•ˆ ë¹„ëŠ” ê±° ë´ë¼ ã…‹ã…‹ã…‹", "ì—°ì´ˆë¡ ì•„ë°”íƒ€ í…ìŠ¤ì²˜ ìˆ˜ì •í•œ ê±°ì„? ê´‘íƒì´ ì¢€ ë‹¬ë¼ì§„ ê±° ê°™ì€ë°.", "ì†”ì§íˆ ì´ ì •ë„ í€„ë¦¬í‹°ë©´ ë©”ì´ì €ë‘ ë¹„ë²¼ë„ ì•ˆ ê¿€ë¦¼.", "ì•„ë‹ˆ ì±ˆë‚˜ ì¶¤ì„  ì–µê¹Œí•˜ë˜ ë†ˆë“¤ ë‹¤ ì–´ë”” ê°”ëƒ? ë¦¬ê¹… ìì—°ìŠ¤ëŸ¬ìš´ ê±° ë´ë¼.", "ì†œì£¼ë¨¹ ì˜ˆëŠ¥ê° ë¯¸ì³¤ë„¤. ì˜¤ëŠ˜ í´ë¦½ ê° í•˜ë‚˜ ë‚˜ì™”ë‹¤.", "ê·¼ë° í•˜ë°ìŠ¤ ì• ë“¤ ì—°ìŠµëŸ‰ ì§„ì§œ ì¥ë‚œ ì•„ë‹Œ ë“¯. ì„±ì¥ ì†ë„ê°€ ë³´ì„.", "ë°©ê¸ˆ ë¦¬ì•¡ì…˜ íƒ€ì´ë° ì§€ë ¸ë‹¤. ì´ê²Œ ë²„ì¶”ì–¼ì˜ ë§›ì´ì§€.", "í•˜ë°ìŠ¤ ìœ ì…ì¸ë° ì…ë• ê°€ì´ë“œ ì–´ë””ì„œ ë´„?", "ì˜¤ëŠ˜ ë°©ì†¡ ë³´ê³  êµ¬ë… ëˆŒë €ë‹¤. ë…¸ë˜ ì£¼ë¨¸ë‹ˆ ë“ ë“ í•˜ë„¤.", "ì–˜ë„¤ëŠ” ë©¤ë²„ë“¤ë¼ë¦¬ í‹°í‚¤íƒ€ì¹´ê°€ ì˜ ë¼ì„œ ë³´ê¸° í¸í•¨.", "ì—°ì´ˆë¡ ë¹„ì£¼ì–¼ ì‹¤í™”ëƒ? ì¸ë„¤ì¼ ë³´ê³  í™€ë¦° ë“¯ ë“¤ì–´ì˜´.", "ì†”ì§íˆ 3D ë¼ì´ë¸Œ í•  ë•Œë§ˆë‹¤ ê¸°ìˆ ë ¥ ë°œì „í•˜ëŠ” ê±° ì²´ê°ë¨.", "í‚¤ë§ˆ ëª©ì†Œë¦¬ëŠ” ì§„ì§œ ë…ë³´ì ì´ë‹¤. ì»¤ë²„ê³¡ í•˜ë‚˜ ë” ë½‘ì•„ì£¼ë¼.", "ì˜¤ëŠ˜ ëµê·¤ ë“œë¦½ ë•Œë¬¸ì— ê´‘ëŒ€ ì•„íŒŒì„œ ë°©ì†¡ ëª» ë³´ê² ìŒ ã…‹ã…‹ã…‹", "í•˜ë°ìŠ¤ ì •ë„ë©´ ë²„ì¶”ì–¼ ì”¬ì—ì„œ íƒ‘í‹°ì–´ ì¸ì •ì´ì§€."];
    const cafeMsgs = ["í•˜ë°ìŠ¤ ë©¤ë²„ë“¤ ì˜¤ëŠ˜ë„ ê³ ìƒ ë§ì•˜ì–´ìš”! í‘¹ ì‰¬ì–´ìš”~", "ì¼€ë¡œ 1ê¸° ì—¬ê¸° ì—¬ê¸° ëª¨ì—¬ë¼! ìš°ë¦¬ í•˜ë°ìŠ¤ ì§€ì¼œ!", "í‚¤ë§ˆë‹˜ ëª©ì†Œë¦¬ëŠ” ì œ ì§€ì¹œ ì¼ìƒì˜ ìœ ì¼í•œ ë¹„íƒ€ë¯¼ì´ì—ìš”.", "ì˜¤ëŠ˜ ëµê·¤ë‹˜ ë•ë¶„ì— ë°°ê¼½ ë¹ ì§€ê²Œ ì›ƒì—ˆë„¤ìš”. í•­ìƒ ê³ ë§ˆì›Œìš”!", "ìš°ë¦¬ ì±ˆë‚˜ë‹˜ ë¯¸ëª¨ê°€ ë§¤ì¼ ê²½ì‹ ë˜ëŠ”ë°... ì œ ì‹¬ì¥ ì±…ì„ì§€ì„¸ìš”!", "ì—°ì´ˆë¡ë‹˜ì˜ ë”°ëœ»í•œ ìœ„ë¡œ ë°©ì†¡ ë•ë¶„ì— ì˜¤ëŠ˜ íë§í•˜ê³  ê°‘ë‹ˆë‹¤.", "ì†œì£¼ë¨¹ë‹˜ ë§¤ë ¥ì— í•œ ë²ˆ ë¹ ì§€ë©´ ì¶œêµ¬ê°€ ì—†ë‹¤ëŠ” ê²Œ í•™ê³„ì˜ ì •ì„¤!", "í•˜ë°ìŠ¤ ê³µì‹ êµ¿ì¦ˆ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”. í†µì¥ì€ ì¤€ë¹„ëìŠµë‹ˆë‹¤!", "ì˜¤ëŠ˜ ë¬´ëŒ€ ë³´ëŠ”ë° ëˆˆë¬¼ ë‚  ë»”í–ˆì–´ìš”. ìš°ë¦¬ ì• ë“¤ ë‹¤ ì»¸ë„¤...", "í•­ìƒ ë…¸ë ¥í•˜ëŠ” ëª¨ìŠµì´ ë„ˆë¬´ ì˜ˆìœ í•˜ë°ìŠ¤, ì˜¤ë˜ì˜¤ë˜ ê°€ì!", "íŒ¬ì•„íŠ¸ ê·¸ë ¤ë´¤ëŠ”ë° ì˜ˆì˜ê²Œ ë´ì£¼ì‹œë©´ ì¢‹ê² ì–´ìš”~", "ìš°ë¦¬ í•˜ë°ìŠ¤ ìŠˆìŠ¤ê¸¸ë§Œ ê±·ì! ì–¸ì œë‚˜ ì‘ì›í• ê²Œ.", "ë©¤ë²„ë“¤ ê±´ê°•ì´ ìµœìš°ì„ ì¸ ê±° ì•Œì£ ? ì•„í”„ì§€ ë§ˆìš” ã… ã… ", "ì˜¤ëŠ˜ ë°©ì†¡ë„ ë ˆì „ë“œ! í•˜ë°ìŠ¤ ë•ë¶„ì— ë‚´ì¼ ì¶œê·¼ë„ ë²„íŒë‹ˆë‹¤.", "ì„¸ìƒì—ì„œ ì œì¼ ë¹›ë‚˜ëŠ” 5ëª…ì˜ ë³„, í•˜ë°ìŠ¤ ì‚¬ë‘í•´!", "ì±ˆë‚˜ë‹˜ ëŒ„ìŠ¤ ë¸Œë ˆì´í¬ ë¶€ë¶„ ë¬´í•œ ë°˜ë³µ ì¤‘ì…ë‹ˆë‹¤. ë„ˆë¬´ ë©‹ì ¸ìš”!", "ë…¸ë˜ë©´ ë…¸ë˜, ì¶¤ì´ë©´ ì¶¤, ëª»í•˜ëŠ” ê²Œ ì—†ëŠ” í•˜ë°ìŠ¤ ìµœê³ !", "í•˜ë°ìŠ¤ ë§Œë‚˜ê³  ì œ ì‚¶ì´ í–‰ë³µí•´ì¡Œì–´ìš”. ê³ ë§ˆì›Œìš” ë©¤ë²„ë“¤!", "ì˜¤ëŠ˜ ë°¤ì€ í•˜ë°ìŠ¤ ë…¸ë˜ ë“¤ìœ¼ë©´ì„œ ì¢‹ì€ ê¿ˆ ê¿€ê²Œìš”~"];

    window.addEventListener('keydown', e => { 
        if (document.activeElement.id === 'post-input') return;
        if (e.code === 'Space') {
            const modal = document.getElementById('eventModal');
            if (modal.style.display === 'block') {
                const btn = modal.querySelector('.primary-btn, .choice-btn');
                if(btn) btn.click();
            } else { if(document.getElementById('start-page').style.display === 'none') nextDay(); }
        }
    });

    function updateFandom(val) {
        gameState.fandom = Math.max(0, gameState.fandom + val);
        gameState.youtube += Math.floor(val * 0.7);
        gameState.sns += Math.floor(val * 1.2);
    }

    function getEquipVal(item) {
        let bonus = 0;
        if (item.level === 1) bonus = 1;      
        else if (item.level === 2) bonus = 3; 
        else if (item.level >= 3) bonus = 5;  
        return item.val + bonus;
    }

    function calculateTierScore() {
        const salesScore = Math.floor(gameState.accumulatedSales / 10000);
        return gameState.fandom + Math.floor(gameState.youtube * 0.5) + Math.floor(gameState.sns * 0.2) + salesScore;
    }

    function getTierInfo(score) {
        if (score >= 15000000) return { name: "ì „ì„¸ê³„ì—ì„œ ì•Œë ¤ì§", class: "tier-world" };
        if (score >= 6000000) return { name: "ë¶ë¯¸ì—ì„œ ì•Œë ¤ì§", class: "tier-na" };
        if (score >= 2000000) return { name: "ì•„ì‹œì•„ì—ì„œ ì•Œë ¤ì§", class: "tier-asia" };
        if (score >= 600000) return { name: "êµ­ë‚´ì—ì„œ ì•Œë ¤ì§", class: "tier-domestic" };
        if (score >= 200000) return { name: "ë¼ì´ì§•ìŠ¤íƒ€", class: "tier-rising" };
        return { name: "ë£¨í‚¤", class: "tier-rookie" };
    }

    // === ì°¨íŠ¸ ê´€ë ¨ í•¨ìˆ˜ ===
    function updateChartRanks() {
        // 1. ëª¨ë“  ê³¡ í•©ì¹˜ê¸° (ë¼ì´ë²Œ + ë‚´ ê³¡)
        const allSongs = [];
        
        // ë¼ì´ë²Œ ê³¡ ì¶”ê°€
        gameState.rivalCharts.forEach(rc => {
            allSongs.push({
                artist: rc.artist,
                title: rc.title,
                scores: rc.scores,
                isPlayer: false,
                ref: rc // ì°¸ì¡° ìœ ì§€
            });
        });

        // í”Œë ˆì´ì–´ ê³¡ ì¶”ê°€
        gameState.activeCharts.forEach(ac => {
            if(ac.weekCount < 6) { // 5ì£¼ì°¨ê¹Œì§€ë§Œ ì°¨íŠ¸ì¸
                allSongs.push({
                    artist: "HADES",
                    title: ac.name,
                    scores: ac.scores,
                    isPlayer: true,
                    ref: ac
                });
            }
        });

        // 2. í”Œë«í¼ë³„ ì •ë ¬ ë° ìˆœìœ„ í• ë‹¹
        const platforms = ['subak', 'musicside', 'tube'];
        
        platforms.forEach(plat => {
            // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            allSongs.sort((a, b) => b.scores[plat] - a.scores[plat]);
            
            // ìˆœìœ„ ë¶€ì—¬ ë° ë“±ë½ ê³„ì‚°
            allSongs.forEach((song, idx) => {
                const rank = idx + 1;
                // ì´ì „ ìˆœìœ„ê°€ ìˆìœ¼ë©´ ë“±ë½ ê³„ì‚°, ì—†ìœ¼ë©´ NEW
                let change = 'new';
                if(song.ref.prevRanks && song.ref.prevRanks[plat] !== 0) {
                    change = song.ref.prevRanks[plat] - rank; // ì–‘ìˆ˜ë©´ ìƒìŠ¹, ìŒìˆ˜ë©´ í•˜ë½
                }
                
                // ì°¸ì¡° ê°ì²´ì— í˜„ì¬ ìˆœìœ„ ì €ì¥ (ë‹¤ìŒ í„´ ë¹„êµìš©)
                if(!song.ref.prevRanks) song.ref.prevRanks = {};
                song.ref.prevRanks[plat] = rank;
                
                // í”Œë ˆì´ì–´ ê³¡ì˜ ê²½ìš° activeCharts ë‚´ rank ì†ì„± ì—…ë°ì´íŠ¸ (ëŒ€í‘œ ìˆœìœ„ëŠ” ìˆ˜ë°• ê¸°ì¤€)
                if(song.isPlayer && plat === 'subak') {
                    song.ref.rank = rank;
                }
            });
        });
    }

    function switchChartTab(tab) {
        gameState.currentChartTab = tab;
        document.querySelectorAll('.chart-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.chart-tab-btn.${tab}`).classList.add('active');
        renderHomeCharts(tab);
    }

    function renderHomeCharts(platform) {
        const container = document.getElementById('chart-list-container');
        
        // í˜„ì¬ í”Œë«í¼ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ëœ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        const allSongs = [];
        gameState.rivalCharts.forEach(s => allSongs.push({...s, isPlayer: false}));
        gameState.activeCharts.forEach(s => {
            if(s.weekCount < 6) allSongs.push({artist: "HADES", title: s.name, scores: s.scores, prevRanks: s.prevRanks, isPlayer: true});
        });

        // ì •ë ¬
        allSongs.sort((a, b) => b.scores[platform] - a.scores[platform]);

        // Top 10 ë Œë”ë§
        const top10 = allSongs.slice(0, 10);
        
        container.innerHTML = top10.map((song, idx) => {
            const rank = idx + 1;
            let changeHtml = '<span class="rank-change">-</span>';
            
            if(song.prevRanks && song.prevRanks[platform]) {
                const diff = song.prevRanks[platform] - rank;
                if(diff > 0) changeHtml = `<span class="rank-change rank-up">â–²${diff}</span>`;
                else if(diff < 0) changeHtml = `<span class="rank-change rank-down">â–¼${Math.abs(diff)}</span>`;
                else changeHtml = `<span class="rank-change">-</span>`;
            } else {
                changeHtml = `<span class="rank-change" style="color:#ff0000; font-weight:bold;">NEW</span>`;
            }

            return `
            <div class="chart-row ${song.isPlayer ? 'my-song' : ''}">
                <div class="rank">${rank}</div>
                ${changeHtml}
                <div class="song-info">
                    <span class="song-title">${song.title}</span>
                    <span class="artist-name">${song.artist}</span>
                </div>
            </div>`;
        }).join('');
    }

    function updateDisplay() {
        document.getElementById('current-day').innerText = gameState.day;
        let d = new Date(gameState.startDate); d.setDate(d.getDate() + (gameState.day - 1));
        const todayStr = d.toISOString().split('T')[0];
        document.getElementById('current-date').innerText = todayStr;
        
        document.getElementById('p-finance').innerText = gameState.finance.toLocaleString() + 'ì›';
        document.getElementById('p-fandom').innerText = gameState.fandom.toLocaleString() + 'ëª…';
        document.getElementById('p-youtube').innerText = gameState.youtube.toLocaleString() + 'ëª…';
        document.getElementById('p-sns').innerText = gameState.sns.toLocaleString() + 'ëª…';
        document.getElementById('p-sales').innerText = gameState.accumulatedSales.toLocaleString() + 'ì›';
        
        const score = calculateTierScore();
        const tierInfo = getTierInfo(score);
        const tierEl = document.getElementById('p-tier');
        tierEl.innerText = tierInfo.name;
        if(score >= 15000000) tierEl.style.color = '#e64980'; else if(score >= 600000) tierEl.style.color = '#7950f2'; else tierEl.style.color = '#868e96';

        const postBtn = document.getElementById('post-submit-btn');
        if (gameState.hasPostedThisWeek) { postBtn.disabled = true; postBtn.innerText = "ì´ë²ˆ ì£¼ ì‘ì„± ì™„ë£Œ"; }
        else { postBtn.disabled = false; postBtn.innerText = "ì‘ì„± ì™„ë£Œ"; }

        // ë©¤ë²„ ì—…ë°ì´íŠ¸
        document.getElementById('member-grid-container').innerHTML = gameState.members.map((m, idx) => {
            const bonuses = { vocal:0, dance:0, visual:0, variety:0, charm:0 };
            m.equipment.forEach(eq => { if(bonuses[eq.stat] !== undefined) bonuses[eq.stat] += getEquipVal(eq); });
            let mentalIcon = "ğŸ˜";
            if (m.mental >= 80) mentalIcon = "ğŸ’"; else if (m.mental <= 30) mentalIcon = "â˜ï¸"; else if (m.mental >= 60) mentalIcon = "ğŸ™‚";
            return `
            <div class="member-card" style="${m.fatigue >= 100 ? 'border-color:var(--danger); background:#fff5f5;' : ''}">
                <button class="equip-btn" onclick="openEquipModal(${idx})">ğŸ’ ì¥ë¹„/ê°•í™”</button>
                <div class="profile-container">
                    <img src="${m.image}" class="profile-img" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=${m.name}'">
                    <div class="profile-info">
                        <div style="font-size:16px; font-weight:bold;">${m.name} <span style="font-size:12px;">${mentalIcon}</span></div>
                        <div style="font-size:11px; color:#999;">ğŸ‚ ${m.birth}</div>
                    </div>
                </div>
                ${renderStat('ë³´ì»¬', m.vocal, bonuses.vocal, 'var(--vocal)')}
                ${renderStat('ëŒ„ìŠ¤', m.dance, bonuses.dance, 'var(--dance)')}
                ${renderStat('ë¹„ì£¼ì–¼', m.visual, bonuses.visual, 'var(--visual)')}
                ${renderStat('ì˜ˆëŠ¥', m.variety, bonuses.variety, 'var(--variety)')}
                ${renderStat('ë§¤ë ¥', m.charm, bonuses.charm, 'var(--charm)')}
                <div class="equipped-items">${m.equipment.length > 0 ? m.equipment.map(e => `[${e.level>0?`+${e.level} `:''}${e.name}]`).join(' ') : 'ì¥ë¹„ ì—†ìŒ'}</div>
                <div style="font-size:11px; text-align:right; color:${m.fatigue >= 100 ? 'var(--danger)' : '#888'}; font-weight:bold;">í”¼ë¡œë„: ${m.fatigue}%</div>
            </div>`;
        }).join('');
        
        // ì»¤ë®¤ë‹ˆí‹° ì—…ë°ì´íŠ¸
        document.getElementById('comm-container').innerHTML = gameState.community.map(c => `
            <div class="comm-post"><span class="comm-site ${c.site==='ì†ë³´'?'site-news':(c.site==='ìŒì›ë°˜ì‘'?'site-music':(c.site==='SNS'?'site-sns':(c.site==='ì—ë±€'?'site-ebem':(c.site==='ë„ˆíŠœë¸Œ'?'site-yt':(c.site==='YZ'?'site-yz':'site-cafe')))))}">${c.site}</span><div style="font-size:13px; margin-top:4px;">${c.content}</div></div>
        `).reverse().join('');

        // ì°¨íŠ¸ UI ë Œë”ë§
        renderHomeCharts(gameState.currentChartTab);
    }

    function renderStat(l, base, bonus, c) { 
        const total = base + bonus;
        return `<div class="stat-row">
            <div class="stat-label">${l}</div>
            <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${Math.min(100, (total/50)*100)}%; background:${total>=50?'#333':c}"></div></div>
            <div style="font-size:10px;">${base}${bonus > 0 ? `<span class="bonus-stat">(+${bonus})</span>` : ''}</div>
        </div>`; 
    }

    function submitPost() {
        if (gameState.hasPostedThisWeek) return;
        const text = document.getElementById('post-input').value; if (!text) return;
        const site = document.getElementById('post-site').value;
        const reactionCount = Math.floor(Math.random() * 301); 
        let bonus = Math.floor((reactionCount / 300) * 800) + 100; 
        let label = (site === 'ì—ë±€') ? "ì¶”ì²œğŸ‘" : (site === 'YZ' ? "LIKE â™¡" : "ì¢‹ì•„ìš”â™¥");
        gameState.pendingPost = { site: site, content: `<b>[ì‘ì„±ê¸€] ${text} (${label} ${reactionCount}) <span style="color:var(--success);">+${bonus.toLocaleString()}ëª…</span></b>`, bonus: bonus };
        gameState.hasPostedThisWeek = true; document.getElementById('post-input').value = ""; updateDisplay();
    }

    function renderContents() {
        const specialList = document.getElementById('special-content-list');
        let albumStatus = gameState.flags.albumPaid ? 
            `<button class="content-btn btn-cooldown" disabled>âœ… ì œì‘ë¹„ ì •ì‚° ì™„ë£Œ (ë°œë§¤ ëŒ€ê¸°/í™œë™ ì¤‘)</button>` : 
            `<button class="content-btn btn-cooldown" disabled>ğŸ”’ 12ì›” 25ì¼ ì •ì‚° ì˜ˆì • (6ì²œë§Œì› í•„ìš”)</button>`;
        
        let concertStatus = gameState.flags.concertBought ?
            `<button class="content-btn btn-cooldown" disabled>âœ… ì˜ˆë§¤ ì™„ë£Œ (1ì›” 19ì¼ ê°œìµœ)</button>` :
            (gameState.flags.concertDone ? `<button class="content-btn btn-cooldown" disabled>ğŸ ê°œìµœ ì™„ë£Œ</button>` : `<button class="content-btn btn-available" onclick="buyConcert()">ì˜ˆë§¤ ì‹œì‘ (ë¹„ìš© 1ì–µ)</button>`);

        specialList.innerHTML = `
            <div class="content-card" style="border-color:#ff4d94; background:#fff0f6;">
                <div class="content-header"><strong>ğŸ’¿ ì •ê·œ í”„ë¡œì íŠ¸ (MEGA PIECE & 2nd Earth)</strong><span class="content-badge badge-special">í•„ìˆ˜</span></div>
                <div class="content-info"><div>ğŸ’° 60,000,000ì›</div><div>ë°œë§¤ì¼: 12/26 & 01/09</div></div>
                ${albumStatus}
            </div>
            <div class="content-card" style="border-color:#ae3ec9; background:#f3f0ff;">
                <div class="content-header"><strong>ğŸ¤ ì˜¨ë¼ì¸ ì½˜ì„œíŠ¸ [B905]</strong><span class="content-badge badge-special">ìŠ¤í˜ì…œ</span></div>
                <div class="content-info"><div>ğŸ’° 100,000,000ì›</div><div>ê°œìµœì¼: 26ë…„ 01ì›” 19ì¼</div></div>
                ${concertStatus}
            </div>
        `;

        const container = document.getElementById('content-list');
        container.innerHTML = Object.values(contentTypes).map(c => {
            const lastDay = gameState.lastContents[c.id];
            const remain = c.cooldown - (gameState.day - lastDay);
            const isAvailable = remain <= 0;
            let btnHtml = '';
            if (gameState.finance < c.cost) btnHtml = `<button class="content-btn btn-cooldown" disabled>ìê¸ˆ ë¶€ì¡±</button>`;
            else if (isAvailable) btnHtml = `<button class="content-btn btn-available" onclick="executeContent('${c.id}')">ì œì‘í•˜ê¸° (-${(c.cost/10000).toLocaleString()}ë§Œ)</button>`;
            else btnHtml = `<button class="content-btn btn-cooldown" disabled>ì¤€ë¹„ ì¤‘ (D-${remain})</button>`;
            return `<div class="content-card"><div class="content-header"><strong>${c.name}</strong><span class="content-badge ${c.badge}">${c.type}</span></div><div class="content-info"><div class="content-stat">ğŸ’° ${(c.cost/10000).toLocaleString()}ë§Œì›</div></div>${btnHtml}</div>`;
        }).join('');
    }

    function buyConcert() {
        if (gameState.finance < 100000000) return alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (1ì–µ ì› í•„ìš”)");
        if (confirm("ì˜¨ë¼ì¸ ì½˜ì„œíŠ¸ [B905]ë¥¼ ê¸°íší•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¹„ìš©: 100,000,000ì›\nê°œìµœì¼: 2026ë…„ 1ì›” 19ì¼")) {
            gameState.finance -= 100000000;
            gameState.flags.concertBought = true;
            alert("ì½˜ì„œíŠ¸ ê¸°íšì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! 1ì›” 19ì¼ì„ ê¸°ëŒ€í•´ì£¼ì„¸ìš”.");
            updateDisplay(); renderContents();
        }
    }

    function executeContent(typeId) {
        const content = contentTypes[typeId];
        gameState.finance -= content.cost;
        gameState.lastContents[typeId] = gameState.day;
        const roll = Math.floor(Math.random() * 100) + 1;
        let resultTitle = "", resultText = "";
        
        gameState.members.forEach(m => m.fatigue = Math.min(100, m.fatigue + (typeId==='short'?10:25)));
        let revenue = 0;

        if (roll <= content.risk) {
            const loss = Math.floor(content.rewardMin * 0.3); updateFandom(-loss);
            revenue = Math.floor(content.cost * 0.2); 
            resultTitle = "ğŸ˜± ì»¨í…ì¸  í­ë§..."; resultText = `ë°˜ì‘ì´ ì‹¸ëŠ˜í•©ë‹ˆë‹¤. (íŒ¬ë¤ -${loss}ëª…)`;
        } else if (roll > 90) { 
            const rawBonus = content.rewardMax + Math.floor(Math.random() * content.rewardMax * 0.5);
            const bonus = Math.floor(rawBonus * 0.5); 
            updateFandom(bonus);
            if(typeId === 'long') { revenue = 50000000 + Math.floor(Math.random() * 50000000); } 
            else { revenue = Math.floor(content.cost * 1.5); }
            resultTitle = "ğŸ”¥ ì´ˆëŒ€ë°• ë°œìƒ!"; resultText = `ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ì¥ì•…! (íŒ¬ë¤ +${bonus.toLocaleString()}ëª…)`;
        } else {
            const rawGain = Math.floor(Math.random() * (content.rewardMax - content.rewardMin)) + content.rewardMin;
            const gain = Math.floor(rawGain * 0.5); 
            updateFandom(gain);
            revenue = Math.floor(content.cost * 0.8); 
            resultTitle = "âœ… ì œì‘ ì™„ë£Œ"; resultText = `ë¬´ë‚œí•œ ë°˜ì‘ì…ë‹ˆë‹¤. (íŒ¬ë¤ +${gain.toLocaleString()}ëª…)`;
        }
        gameState.finance += revenue; if(revenue > 0) gameState.accumulatedSales += revenue;
        document.getElementById('modal-title').innerText = resultTitle; document.getElementById('modal-body').innerHTML = resultText;
        document.getElementById('modal-choices').innerHTML = `<button class="primary-btn" onclick="closeModal()">í™•ì¸</button>`;
        document.getElementById('eventModal').style.display = 'block'; updateDisplay(); renderContents();
    }

    function checkDateEvents(d) {
        const dateStr = d.toISOString().split('T')[0];
        
        if (dateStr === '2025-12-25') {
            gameState.popupQueue.unshift({ 
                type: 'settlement',
                event: {
                    id: 'settle_1225', title: 'ğŸ’¸ ìš´ëª…ì˜ ì •ì‚°ì¼', desc: 'MEGA PIECE HARMONYì™€ ë‘ ë²ˆì§¸ ì§€êµ¬ ì œì‘ë¹„ ì •ì‚°ì¼ì…ë‹ˆë‹¤.\ní•„ìš” ê¸ˆì•¡: 60,000,000ì›\n\n(ë‚©ë¶€í•˜ì§€ ëª»í•˜ë©´ íŒŒì‚° ì²˜ë¦¬ë©ë‹ˆë‹¤.)',
                    choices: [
                        { text: "ì •ì‚°í•˜ê¸° (6ì²œë§Œì› ì§€ë¶ˆ)", effect: () => payAlbumCost() },
                        { text: "ëˆì´ ì—†ë‹¤... (ë°°ì§¸ë¼)", effect: () => { alert("ì œì‘ë¹„ ë¯¸ë‚©ìœ¼ë¡œ ì†Œì†ì‚¬ê°€ ì••ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nGAME OVER"); location.reload(); } }
                    ]
                }
            });
        }
        if (dateStr === '2025-12-26' && gameState.flags.albumPaid) { launchSong("MEGA PIECE HARMONY"); }
        if (dateStr === '2026-01-09' && gameState.flags.albumPaid) { launchSong("ë‘ ë²ˆì§¸ ì§€êµ¬"); }
        if (dateStr === '2026-01-19') {
            if (gameState.flags.concertBought) { runConcert(); } 
            else { gameState.community.push({site:'ì†ë³´', content:'<b>[ì´ìŠˆ] í•˜ë°ìŠ¤, ì˜ˆì‚° ë¶€ì¡±ìœ¼ë¡œ ì½˜ì„œíŠ¸ ë¬´ì‚°... íŒ¬ë“¤ "ì‹¤ë§"</b>'}); }
        }
    }

    function payAlbumCost() {
        if (gameState.finance < 60000000) {
            alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤... íŒŒì‚°í–ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } else {
            gameState.finance -= 60000000;
            gameState.flags.albumPaid = true;
            alert("ì •ì‚° ì™„ë£Œ! ì´ì œ ìŒì› ë°œë§¤ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤.");
            updateDisplay(); renderContents();
        }
    }

    function launchSong(title) {
        // ë‚´ ê³¡ ì°¨íŠ¸ ì§„ì… (ì´ˆê¸° ì ìˆ˜ 5000)
        gameState.activeCharts.push({ 
            name: title, 
            weekCount: 0, 
            releaseDate: new Date(gameState.startDate.getTime() + (gameState.day-1)*86400000),
            scores: { subak: 5000, musicside: 5000, tube: 5000 },
            prevRanks: { subak: 0, musicside: 0, tube: 0 }
        });

        gameState.popupQueue.push({
            type: 'release',
            event: {
                id: 'rel_'+title, title: `ğŸ’¿ [ë°œë§¤] ${title}`, desc: `ë””ì§€í„¸ ì‹±ê¸€ <${title}>ê°€ ë°œë§¤ë˜ì—ˆìŠµë‹ˆë‹¤!\nìŒì› ì‚¬ì´íŠ¸ ì°¨íŠ¸ ì§„ì…ì„ ë…¸ë ¤ë´…ì‹œë‹¤.`,
                choices: [{ text: "í™•ì¸", effect: () => updateDisplay() }]
            }
        });
        gameState.community.push({site:'ìŒì›ë°˜ì‘', content: `<b><${title}> ë…¸ë˜ ê°œì¢‹ìŒ;; ë¬´í•œìŠ¤ë° ê°„ë‹¤</b>`});
    }

    function runConcert() {
        gameState.flags.concertDone = true;
        const viewers = Math.floor(Math.random() * (60000 - 40000 + 1)) + 40000; 
        const ticketPrice = 33000;
        const revenue = viewers * ticketPrice;
        const fanInc = Math.floor(viewers * 0.3);

        gameState.finance += revenue;
        gameState.accumulatedSales += revenue;
        updateFandom(fanInc);

        gameState.popupQueue.push({
            type: 'concert',
            event: {
                id: 'con_b905', title: 'ğŸ¤ ì˜¨ë¼ì¸ ì½˜ì„œíŠ¸ [B905] ì¢…ë£Œ',
                desc: `ì½˜ì„œíŠ¸ê°€ ì„±í™©ë¦¬ì— ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì ‘ì† ì‹œì²­ì: ${viewers.toLocaleString()}ëª…\ní‹°ì¼“ ìˆ˜ìµ: ${revenue.toLocaleString()}ì›\níŒ¬ë¤ ìœ ì…: +${fanInc.toLocaleString()}ëª…`,
                choices: [{ text: "ë’¤í’€ì´ íšŒì‹í•˜ëŸ¬ ê°€ì!", effect: () => { gameState.finance-=1000000; alert("íšŒì‹ë¹„ë¡œ 100ë§Œì›ì„ ì¼ìŠµë‹ˆë‹¤. ë©¤ë²„ë“¤ì˜ ì‚¬ê¸°ê°€ ì˜¤ë¦…ë‹ˆë‹¤!"); gameState.members.forEach(m=>m.mental=Math.min(100, m.mental+10)); } }]
            }
        });
    }

    // ì¼ì¼ ì°¨íŠ¸ ë¡œì§ ì²˜ë¦¬
    function processCharts() {
        // ë©¤ë²„ í‰ê·  ëŠ¥ë ¥ì¹˜ ê³„ì‚°
        let totalStat = 0;
        gameState.members.forEach(m => {
            let eqBonus = 0; m.equipment.forEach(e => eqBonus += getEquipVal(e));
            totalStat += (m.vocal + m.dance + m.visual + m.variety + m.charm + eqBonus);
        });
        const teamScore = totalStat / 5; // í‰ê· 

        // 1. ë¼ì´ë²Œ ì ìˆ˜ ë³€ë™
        gameState.rivalCharts.forEach(rc => {
            // ëœë¤ ë“±ë½ (-500 ~ +500)
            rc.scores.subak += Math.floor(Math.random() * 1000) - 500;
            rc.scores.musicside += Math.floor(Math.random() * 1500) - 750; // ë³€ë™í­ í¼
            rc.scores.tube += Math.floor(Math.random() * 2000) - 1000; // ë³€ë™í­ ë§¤ìš° í¼
            
            // ì ìˆ˜ ë³´ì • (0~12000 ì‚¬ì´ ìœ ì§€)
            for(let key in rc.scores) {
                rc.scores[key] = Math.max(0, Math.min(12000, rc.scores[key]));
            }
        });

        // 2. ë‚´ ê³¡ ì ìˆ˜ ë³€ë™
        gameState.activeCharts.forEach(ac => {
            if (ac.weekCount >= 6) return; // ì°¨íŠ¸ ì•„ì›ƒ

            // ê¸°ë³¸ ì„±ì¥ë ¥ (ëŠ¥ë ¥ì¹˜ ê¸°ë°˜)
            const power = Math.floor(teamScore * 2); 
            
            // ìˆ˜ë°•: ê¾¸ì¤€í•¨ (ëŠ¥ë ¥ì¹˜ ë¹„ì¤‘ ë†’ìŒ)
            ac.scores.subak += power + Math.floor(Math.random() * 600) - 200;
            
            // ë®¤ì§ì‚¬ì´ë“œ: íŒ¬ë¤ ë¹„ì¤‘ ë†’ìŒ
            ac.scores.musicside += power + Math.floor(gameState.fandom / 5000) + Math.floor(Math.random() * 800) - 400;

            // ë„ˆíŠœë¸Œ: ëœë¤ í„°ì§ (ëŠ¥ë ¥ì¹˜ ë‚®ì•„ë„ ëŒ€ë°• ê°€ëŠ¥)
            if(Math.random() < 0.1) {
                ac.scores.tube += 2000; // ì•Œê³ ë¦¬ì¦˜ íƒ
                gameState.community.push({site:'ë„ˆíŠœë¸Œ', content: `<b>[ì•Œê³ ë¦¬ì¦˜] <${ac.name}> ì‡¼ì¸  ë–¡ìƒ ì¤‘ ã„·ã„·</b>`});
            } else {
                ac.scores.tube += power + Math.floor(Math.random() * 1000) - 500;
            }

            // ì°¨íŠ¸ ì•„ì›ƒ ë°©ì§€ (ìµœì†Œ ì ìˆ˜ ë³´ì •)
            for(let key in ac.scores) ac.scores[key] = Math.max(0, ac.scores[key]);
        });

        updateChartRanks(); // ìˆœìœ„ ì¬ê³„ì‚°

        // ì¼ê°„ ë³´ìƒ (ìˆ˜ë°• ì°¨íŠ¸ ê¸°ì¤€)
        gameState.activeCharts.forEach(ac => {
            if(ac.rank <= 100) {
                const dailyRevenue = (101 - ac.rank) * 10000; // 1ìœ„ 100ë§Œì›, 100ìœ„ 1ë§Œì›
                const dailyFan = (101 - ac.rank) * 10;
                gameState.finance += dailyRevenue;
                gameState.accumulatedSales += dailyRevenue;
                updateFandom(dailyFan);
            }
            
            if(Math.random() < 0.2) {
                gameState.community.push({site:'ìŒì›ë°˜ì‘', content: musicReactions[Math.floor(Math.random()*musicReactions.length)]});
            }
        });
        
        // ì£¼ê°„ ì°¨íŠ¸ ì²´í¬
        if (gameState.day % 7 === 0) {
            gameState.activeCharts.forEach(song => {
                song.weekCount++;
                if (song.weekCount <= 5) {
                    gameState.popupQueue.push({
                        type: 'chart_week',
                        event: {
                            id: `wk_${song.name}_${song.weekCount}`, title: `ğŸ“Š ì£¼ê°„ ì°¨íŠ¸ (${song.weekCount}ì£¼ì°¨)`,
                            desc: `<${song.name}> ì„±ì í‘œ\n\nğŸˆ ìˆ˜ë°•: ${song.prevRanks.subak}ìœ„\nğŸ’¿ ë®¤ì§ì‚¬ì´ë“œ: ${song.prevRanks.musicside}ìœ„\nğŸ“º ë„ˆíŠœë¸Œ: ${song.prevRanks.tube}ìœ„`,
                            choices: [{ text: "í™•ì¸", effect: () => {} }]
                        }
                    });
                }
            });
        }
    }

    function checkBirthday() {
        let d = new Date(gameState.startDate); d.setDate(d.getDate() + (gameState.day - 1));
        let todayStr = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        gameState.members.forEach(m => { if(m.birth === todayStr) gameState.popupQueue.push({type: 'birthday', event: { id:'bday_'+m.name, title: `ğŸ‚ ${m.name} ìƒì¼`, desc: `ì˜¤ëŠ˜ì€ ${m.name}ì˜ ìƒì¼ì…ë‹ˆë‹¤!`, choices: [{ text: "íŒŒí‹° (íŒ¬ë¤+10000)", effect: () => updateFandom(10000) }] }}); });
    }

    function checkBusinessProposal() {
        if (gameState.day > 30 && gameState.day % 60 === Math.floor(Math.random() * 10)) { 
            const types = ["êµ¿ì¦ˆ íŒì—…ìŠ¤í† ì–´", "íŒ¬ë¯¸íŒ…", "íƒ€ ê²Œì„ ì½œë¼ë³´", "ìŒë£Œ ê´‘ê³ "];
            const type = types[Math.floor(Math.random() * types.length)];
            const profit = Math.floor(Math.random() * 20000001) + 30000000; 
            gameState.popupQueue.push({
                type: 'business',
                event: {
                    id: 'biz_'+gameState.day, title: `ğŸ’¼ [ì œì•ˆ] ${type}`, desc: `${type} ì œì•ˆì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤.\nì„±ê³µ ì‹œ ìˆ˜ìµ, ì‹¤íŒ¨ ì‹œ ì†í•´ê°€ ë°œìƒí•©ë‹ˆë‹¤.`,
                    choices: [ { text: "ìˆ˜ë½í•˜ê¸° (ë„ì „!)", effect: () => executeBusiness(profit, type) }, { text: "ê±°ì ˆí•˜ê¸°", effect: () => {} } ]
                }
            });
        }
    }
    
    function executeBusiness(amount, type) {
        if (Math.random() < 0.7) { 
            gameState.finance += amount; gameState.accumulatedSales += amount; 
            alert(`ğŸ‰ ëŒ€ì„±ê³µ!\n${type}ê°€ ëŒ€ë°•ë‚˜ì„œ ${amount.toLocaleString()}ì›ì„ ë²Œì—ˆìŠµë‹ˆë‹¤!`);
        } else { 
            gameState.finance -= amount;
            alert(`ğŸ˜­ ì‹¤íŒ¨...\n${type}ê°€ ë¶€ì§„í•˜ì—¬ ${amount.toLocaleString()}ì› ì†í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
        }
        updateDisplay();
    }

    function checkTierUp() {
        const score = calculateTierScore();
        const newTierInfo = getTierInfo(score);
        const oldTierName = gameState.currentTier || "UNRANKED";
        if (tierOrder.indexOf(newTierInfo.name) > tierOrder.indexOf(oldTierName)) {
            gameState.popupQueue.push({
                type: 'tier_up',
                event: {
                    id: 'tierup_'+gameState.day, title: "ğŸ‰ ì¸ì§€ë„ ë“±ê¸‰ ìƒìŠ¹!",
                    desc: `ì¶•í•˜í•©ë‹ˆë‹¤! í•˜ë°ìŠ¤ì˜ ì¸ì§€ë„ê°€ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.`,
                    choices: [{ text: "í™•ì¸", effect: () => {} }],
                    customHtml: `<div class="${newTierInfo.class} tier-badge">${newTierInfo.name}</div><div style="margin-top:10px;">ì´ì œ ë” ë§ì€ ì‚¬ëŒë“¤ì´ ìš°ë¦¬ë¥¼ ì•Œì•„ë´…ë‹ˆë‹¤!</div>`
                }
            });
        }
        gameState.currentTier = newTierInfo.name;
    }

    function checkSeasonReport() {
        if (gameState.day % 180 === 0) {
            const score = calculateTierScore();
            const info = getTierInfo(score);
            gameState.popupQueue.push({ type: 'season', event: { id: 'season_'+gameState.day, title: `ğŸ† ì‹œì¦Œ ${gameState.day/180} ê²°ì‚°`, desc: "ì§€ë‚œ 6ê°œì›”ê°„ì˜ ì„±ê³¼ ë³´ê³ ì„œì…ë‹ˆë‹¤.", choices: [{ text: "í™•ì¸", effect: () => {} }], customHtml: `<div class="${info.class} tier-badge">${info.name}</div><div style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:5px; font-size:12px; text-align:left;">íŒ¬ë¤: ${gameState.fandom.toLocaleString()}<br>ëˆ„ì ë§¤ì¶œ: ${gameState.accumulatedSales.toLocaleString()}ì›<br>ì¢…í•©ì ìˆ˜: ${score.toLocaleString()}ì </div>` } });
        }
    }

    function nextDay() {
        if (document.getElementById('eventModal').style.display === 'block') return;
        if (gameState.finance < -50000000) { alert(`ğŸš« íŒŒì‚° ì„ ê³  ğŸš«\n\nìµœì¢… íŒ¬ë¤: ${gameState.fandom.toLocaleString()}ëª…`); location.reload(); return; }

        let totalProfit = Math.floor(Math.random() * 800001) + 400000;
        let isHit = totalProfit >= 1000000;
        if (isHit) gameState.youtube += Math.floor(Math.random() * 7001) + 3000;

        const actionsPool = ['vocal', 'dance', 'visual', 'variety', 'charm', 'rest'];
        if (gameState.day % 7 === 1 && gameState.day > 1) gameState.hasPostedThisWeek = false;

        gameState.members.forEach(m => {
            let action = m.manualAct || actionsPool[Math.floor(Math.random() * actionsPool.length)];
            let mentalFactor = 1.2 - ((m.mental / 100) * 0.4); 
            if (action === 'rest') m.fatigue = Math.max(0, m.fatigue - 40);
            else if (m.fatigue < 100) {
                let prev = m[action];
                if (m[action] < 50 && Math.random() < 0.4) { 
                    m[action]++; gameState.weeklyStats.push({name: m.name, stat: action, from: prev, to: m[action]}); 
                    m.fatigue = Math.min(100, m.fatigue + (20 * mentalFactor)); 
                } else m.fatigue = Math.min(100, m.fatigue + (15 * mentalFactor));
            }
            m.manualAct = null; m.fatigue = Math.floor(m.fatigue); 
        });

        if (Math.random() < 0.05) gameState.community.push({site:'ì†ë³´', content: `<b>[NEWS] ${newsHeadlines[Math.floor(Math.random()*newsHeadlines.length)]}</b>`});
        else if (Math.random() < 0.3) gameState.community.push({site:'ì—ë±€', content: ebemMsgs[Math.floor(Math.random()*ebemMsgs.length)]});
        else if (Math.random() < 0.3) gameState.community.push({site:'íŒ¬ì¹´í˜', content: cafeMsgs[Math.floor(Math.random()*cafeMsgs.length)]});
        
        if (gameState.pendingPost) { gameState.community.push({site: gameState.pendingPost.site, content: gameState.pendingPost.content}); updateFandom(gameState.pendingPost.bonus); gameState.pendingPost = null; }
        if (gameState.community.length > 50) gameState.community.shift();

        let d = new Date(gameState.startDate); d.setDate(d.getDate() + (gameState.day - 1));
        
        checkDateEvents(d); 
        processCharts(); // ì°¨íŠ¸ ê³„ì‚°
        checkBirthday(); checkBusinessProposal(); checkTierUp(); checkSeasonReport(); 

        if(gameState.day % 7 === 0) { gameState.popupQueue.push({type: 'training_report', data: [...gameState.weeklyStats]}); gameState.weeklyStats = []; }
        
        gameState.finance += totalProfit; gameState.accumulatedSales += totalProfit; 
        gameState.finance -= 500000; updateFandom(Math.floor(totalProfit / 10000));
        
        document.getElementById('profit-report').style.display = 'block';
        document.getElementById('profit-content').innerHTML = `ìˆ˜ìµ: <span class="money-text">${totalProfit.toLocaleString()}ì›</span>${isHit ? '<br><span style="color:red;">ğŸ”¥ ì¡°íšŒìˆ˜ ê¸‰ìƒìŠ¹!</span>' : ''}`;
        
        gameState.day++; updateDisplay(); processNextPopup();
    }

    let currentEvent = null;
    function processNextPopup() {
        if (document.getElementById('eventModal').style.display === 'block' || gameState.popupQueue.length === 0) return;
        const item = gameState.popupQueue.shift();
        
        if(item.type === 'season' || item.type === 'tier_up') {
            document.getElementById('modal-title').innerText = item.event.title;
            document.getElementById('modal-body').innerHTML = item.event.customHtml;
            document.getElementById('modal-choices').innerHTML = `<button class="primary-btn" onclick="closeModal()">í™•ì¸</button>`;
            document.getElementById('eventModal').style.display = 'block';
        } else if(item.type === 'training_report') {
            showTrainingReport(item.data);
        } else {
            renderEventPopup(item.event, item.type === 'birthday');
        }
    }

    function renderEventPopup(ev, isSpecial) {
        currentEvent = ev;
        document.getElementById('modal-title').innerText = ev.title; document.getElementById('modal-body').innerText = ev.desc;
        let choicesHtml = ev.choices.map((c, idx) => `<button class="${isSpecial && idx===0?'primary-btn':'choice-btn'}" onclick="handleChoice(${idx})" style="margin-bottom:5px;">${c.text}</button>`).join('');
        document.getElementById('modal-choices').innerHTML = choicesHtml; document.getElementById('eventModal').style.display = 'block';
    }

    window.handleChoice = function(idx) { if(currentEvent && currentEvent.choices[idx]) { currentEvent.choices[idx].effect(); } closeModal(); };

    function showTrainingReport(logs) {
        document.getElementById('modal-title').innerText = "ğŸ—“ï¸ ì£¼ê°„ ê²°ì‚°";
        let listHtml = logs.length > 0 ? Object.entries(logs.reduce((acc, l) => { if (!acc[l.name]) acc[l.name] = []; acc[l.name].push(`${{vocal:'ë³´ì»¬',dance:'ëŒ„ìŠ¤',visual:'ë¹„ì£¼ì–¼',variety:'ì˜ˆëŠ¥',charm:'ë§¤ë ¥'}[l.stat]}â†‘`); return acc; }, {})).map(([n, s]) => `<div><b>${n}</b>: ${s.join(', ')}</div>`).join('') : "ë³€í™” ì—†ìŒ";
        document.getElementById('modal-body').innerHTML = `<div style="text-align:left; background:#f8f9fa; padding:15px; border-radius:10px;">${listHtml}</div>`;
        document.getElementById('modal-choices').innerHTML = `<button class="primary-btn" onclick="closeModal()">í™•ì¸ (Space)</button>`;
        document.getElementById('eventModal').style.display = 'block';
    }

    function closeModal() { document.getElementById('eventModal').style.display = 'none'; setTimeout(processNextPopup, 150); }
    
    function renderShop() {
        const moneyDisplay = `<div style="padding:10px; background:#e9ecef; border-radius:8px; margin-bottom:15px; font-weight:bold; text-align:center;">í˜„ì¬ ë³´ìœ  ìê¸ˆ: <span style="color:var(--money)">${gameState.finance.toLocaleString()}ì›</span></div>`;
        document.getElementById('shop-list').innerHTML = moneyDisplay + shopItems.map(item => `
            <div class="content-card">
                <div class="content-header"><strong>${item.name}</strong><span class="content-badge badge-item">${item.stat.toUpperCase()} +${item.val}</span></div>
                <div class="content-info"><div>ğŸ’° ${item.price.toLocaleString()}ì›</div><div>${item.desc}</div></div>
                <button class="content-btn ${gameState.finance >= item.price ? 'btn-available' : 'btn-cooldown'}" ${gameState.finance < item.price ? 'disabled' : ''} onclick="buyItem('${item.id}')">êµ¬ë§¤í•˜ê¸°</button>
            </div>
        `).join('');
    }
    
    function buyItem(id) {
        const item = shopItems.find(i => i.id === id);
        if(gameState.finance >= item.price) {
            gameState.finance -= item.price;
            gameState.inventory.push({ ...item, level: 0 });
            alert(`${item.name}ì„(ë¥¼) êµ¬ë§¤í•˜ì—¬ ì°½ê³ ì— ë³´ê´€í–ˆìŠµë‹ˆë‹¤.`);
            updateDisplay(); renderShop();
        }
    }
    
    function openEquipModal(memberIdx) {
        const m = gameState.members[memberIdx];
        document.getElementById('modal-title').innerText = `${m.name} ì¥ë¹„ & ê°•í™”`;
        let equipHtml = `<h4 style="margin:5px 0;">í˜„ì¬ ì°©ìš© ì¤‘ (ê°•í™” ê°€ëŠ¥)</h4>`;
        if(m.equipment.length === 0) equipHtml += `<div style="color:#999; font-size:12px; margin-bottom:10px;">ì°©ìš© ì¤‘ì¸ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        else {
            equipHtml += m.equipment.map((eq, i) => {
                const isMax = eq.level >= 3; const nextCost = !isMax ? Math.floor(eq.price * upgradeConfig[eq.level].costMult) : 0;
                return `<div class="choice-btn" style="margin-bottom:8px;"><div style="flex:1;"><span style="display:block;"><b>${eq.level>0 ? `<span class="enhance-text">+${eq.level}</span> ` : ''}${eq.name}</b> (${eq.stat} +${getEquipVal(eq)})</span>${!isMax ? `<span style="font-size:11px; color:#666;">ê°•í™”ë¹„ìš©: ${nextCost.toLocaleString()}ì›</span>` : '<span style="font-size:11px; color:#845ef7;">ìµœê³  ë ˆë²¨ ë„ë‹¬ (MAX)</span>'}</div><div style="display:flex; align-items:center;">${!isMax ? `<button class="upgrade-btn" onclick="tryUpgrade(${memberIdx}, ${i})">ê°•í™”</button>` : ''}<button class="upgrade-btn" style="background:#fa5252;" onclick="unequipItem(${memberIdx}, ${i})">í•´ì œ</button></div></div>`;
            }).join('');
        }
        let invHtml = `<h4 style="margin:15px 0 5px 0;">ë³´ìœ  ì¥ë¹„ (ì°½ê³ )</h4>`;
        if(gameState.inventory.length === 0) invHtml += `<div style="color:#999; font-size:12px;">ì°½ê³ ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤. ìƒì ì—ì„œ êµ¬ë§¤í•˜ì„¸ìš”.</div>`;
        else { invHtml += gameState.inventory.map((item, i) => `<button class="choice-btn" onclick="equipItem(${memberIdx}, ${i})"><span>ğŸ”µ ${item.name} (${item.stat} +${item.val})</span><span>ì¥ì°©</span></button>`).join(''); }
        document.getElementById('modal-body').innerHTML = `<div style="text-align:left;">${equipHtml}${invHtml}</div>`;
        document.getElementById('modal-choices').innerHTML = `<button class="primary-btn" onclick="closeModal()">ë‹«ê¸°</button>`;
        document.getElementById('eventModal').style.display = 'block';
    }
    
    function tryUpgrade(memberIdx, eqIdx) {
        const item = gameState.members[memberIdx].equipment[eqIdx]; const config = upgradeConfig[item.level]; const cost = Math.floor(item.price * config.costMult);
        if (gameState.finance < cost) { alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
        gameState.finance -= cost;
        if (Math.random() < config.chance) { item.level++; alert(`âœ¨ ê°•í™” ì„±ê³µ! (+${item.level})`); } else { alert(`ğŸ’¥ ê°•í™” ì‹¤íŒ¨...`); }
        updateDisplay(); openEquipModal(memberIdx);
    }
    
    function equipItem(memberIdx, invIdx) { 
        const item = gameState.inventory[invIdx]; const member = gameState.members[memberIdx];
        if (member.equipment.some(e => e.id === item.id)) { alert("ì´ë¯¸ ë™ì¼í•œ ì¥ë¹„ë¥¼ ì°©ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤."); return; }
        gameState.inventory.splice(invIdx, 1); member.equipment.push(item); openEquipModal(memberIdx); updateDisplay(); 
    }
    
    function unequipItem(memberIdx, eqIdx) { const item = gameState.members[memberIdx].equipment.splice(eqIdx, 1)[0]; gameState.inventory.push(item); openEquipModal(memberIdx); updateDisplay(); }

    function openPage(pId, btn) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(pId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        if(pId === 'manual') document.getElementById('sel-member').innerHTML = gameState.members.map((m,i)=>`<option value="${i}">${m.name} (í”¼ë¡œ:${m.fatigue}%)</option>`).join('');
        if(pId === 'contents') renderContents();
        if(pId === 'store') renderShop();
    }
    function manualTrainAction() { const idx = document.getElementById('sel-member').value; gameState.members[idx].manualAct = document.getElementById('sel-stat').value; alert("ì§€ì‹œ ì™„ë£Œ"); }
</script>
</body>
</html>
