<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í•˜ë°ìŠ¤ í‚¤ìš°ê¸° v13.3</title>
    <style>
        :root { --bg: #f5f7fa; --card: #ffffff; --point: #ff4d94; --text: #333; --border: #e1e4e8; --success: #40c057; --vocal: #ff4d94; --dance: #ae3ec9; --visual: #4dadff; --variety: #fab005; --charm: #f06595; --money: #2b8a3e; --danger: #fa5252; --sns: #405de6; --yt: #ff0000; --yz: #000000; }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; line-height: 1.5; overflow-x: hidden; }
        
        #start-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; color: white; text-align: center;
        }
        .start-logo { font-size: 3rem; font-weight: 900; color: var(--point); margin-bottom: 10px; text-shadow: 0 0 20px rgba(255,77,148,0.5); }
        .start-sub { font-size: 1.1rem; opacity: 0.8; margin-bottom: 40px; }
        .start-btn { 
            padding: 18px 60px; background: var(--point); color: white; border: none; 
            border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 20px rgba(255,77,148,0.3); transition: 0.3s;
        }
        .start-btn:hover { transform: scale(1.05); background: #ff3385; }

        .nav-bar { display: none; background: white; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; padding: 15px 5px; border: none; background: transparent; color: #666; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .nav-btn.active { color: var(--point); border-bottom: 3px solid var(--point); background: #fffafc; }

        .container { display: none; max-width: 900px; margin: 0 auto; padding: 15px 15px 100px 15px; }
        .page { display: none; }
        .page.active { display: block; }

        .card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; }
        
        .date-display { position: relative; text-align: right; margin-bottom: 10px; }
        @media (min-width: 600px) {
            .date-display { position: absolute; top: 15px; right: 25px; }
        }
        
        .day-count { font-weight: bold; color: var(--point); font-size: 18px; display: block; }
        .real-date { font-size: 12px; color: #888; }
        
        h2 { color: #222; font-size: 1.1rem; margin-top: 0; border-left: 4px solid var(--point); padding-left: 10px; margin-bottom: 15px; }
        .money-text { color: var(--money); font-weight: bold; }

        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .stat-item small { color: #777; font-size: 11px; }
        .stat-item strong { font-size: 15px; display: block; margin-top: 2px; }

        .comm-post { border-bottom: 1px solid #eee; padding: 10px 0; }
        .comm-site { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
        .site-ebem { background: #e7f5ff; color: #1971c2; }
        .site-cafe { background: #fff0f6; color: #d6336c; }
        .site-sns { background: #f0f1ff; color: var(--sns); }
        .site-yt { background: #ffe3e3; color: var(--yt); }
        .site-yz { background: #000; color: #fff; }

        .member-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 650px) {
            .member-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .member-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; }
        .stat-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 12px; }
        .stat-label { width: 40px; color: #777; font-size: 11px; }
        .stat-bar-bg { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 0 8px; }
        .stat-bar-fill { height: 100%; border-radius: 4px; transition: 0.5s; }

        .next-day-bar { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 12px; border-top: 1px solid var(--border); text-align: center; z-index: 100; box-sizing: border-box; }
        
        .primary-btn { width: 100%; padding: 14px; background: var(--point); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .choice-btn { width: 100%; padding: 14px; background: #f1f3f5; color: #333; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; margin-bottom: 8px; text-align: left; font-size: 14px; }

        .modal-overlay { display: none; position: fixed; z-index: 9000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
        .modal-content { background:white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding:25px; width: 85%; max-width:400px; border-radius:20px; text-align:center; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="start-page">
    <div class="start-logo">HADES</div>
    <div class="start-sub">Virtual Idol Management Simulation</div>
    <button class="start-btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
</div>

<div class="nav-bar" id="main-nav">
    <button class="nav-btn active" onclick="openPage('home', this)">ğŸ“Š í™ˆ</button>
    <button class="nav-btn" onclick="openPage('members', this)">ğŸ‘¥ ë©¤ë²„</button>
    <button class="nav-btn" onclick="openPage('manual', this)">ğŸ“… ì§€ì‹œ</button>
</div>

<div class="container" id="main-container">
    <div id="home" class="page active">
        <div class="card">
            <div class="date-display">
                <span class="day-count">ìš´ì˜ <span id="current-day">1</span>ì¼ì°¨</span>
                <span class="real-date" id="current-date">2025-09-05</span>
            </div>
            <h2>ìƒíƒœ</h2>
            <div class="stat-grid">
                <div class="stat-item"><small>ë³´ìœ  ìì‚°</small><strong id="p-finance" class="money-text">200,000,000ì›</strong></div>
                <div class="stat-item"><small>íŒ¬ì¹´í˜ íšŒì›</small><strong id="p-fandom">110,000ëª…</strong></div>
                <div class="stat-item"><small>ë„ˆíŠœë¸Œ êµ¬ë…</small><strong id="p-youtube">20,000ëª…</strong></div>
                <div class="stat-item"><small>SNS íŒ”ë¡œì›Œ</small><strong id="p-sns">1,000ëª…</strong></div>
            </div>
        </div>

        <div class="card">
            <h2>âœï¸ ì»¤ë®¤ë‹ˆí‹° ê¸€ ì‘ì„±</h2>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <select id="post-site" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="íŒ¬ì¹´í˜">íŒ¬ì¹´í˜</option>
                    <option value="ì—ë±€">ì—ë±€</option>
                    <option value="YZ">YZ</option>
                </select>
                <button class="primary-btn" style="flex: 1.5; padding: 10px; font-size: 14px;" onclick="writeCommunityPost()">ê²Œì‹œê¸€ ì—…ë¡œë“œ</button>
            </div>
            <input type="text" id="post-content" placeholder="í™ë³´ ê²Œì‹œê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px;">
            <p id="post-status-msg" style="font-size: 11px; color: #888; margin-top: 8px; margin-bottom: 0;">* ì¼ì£¼ì¼ì— í•œ ë²ˆë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤. (ë‹¤ìŒ ë‚  ë°˜ì‘ í™•ì¸)</p>
        </div>

        <div class="card" id="profit-report" style="display:none; background: #f2fcf0; border-color: #40c057;">
            <h2>ğŸˆ ì¼ì¼ ë¬¼í’ì„  ìˆ˜ìµ</h2>
            <div id="profit-content" style="font-size: 14px;"></div>
        </div>
        <div class="card">
            <h2>ğŸŒ ì‹¤ì‹œê°„ ë°˜ì‘</h2>
            <div id="comm-container"></div>
        </div>
    </div>

    <div id="members" class="page">
        <div class="member-grid" id="member-grid-container"></div>
    </div>

    <div id="manual" class="page">
        <div class="card">
            <h2>ìˆ˜ë™ ì§€ì‹œ</h2>
            <select id="sel-member" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;"></select>
            <select id="sel-stat" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
                <option value="vocal">ğŸ¤ ë³´ì»¬ ì§‘ì¤‘ í›ˆë ¨</option>
                <option value="dance">ğŸ’ƒ ì•ˆë¬´ ì—°ìŠµ</option>
                <option value="visual">âœ¨ ë¹„ì£¼ì–¼ ì¼€ì–´</option>
                <option value="variety">ğŸ—£ï¸ ì˜ˆëŠ¥ ìŠ¤í”¼ì¹˜</option>
                <option value="charm">ğŸ€ ë§¤ë ¥ ê°•í™”</option>
                <option value="stream">ğŸ“¡ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</option>
                <option value="rest">ğŸ’¤ ê¿€ê°™ì€ íœ´ì‹</option>
            </select>
            <button class="primary-btn" onclick="manualTrainAction()">ì§€ì‹œ ì™„ë£Œ</button>
        </div>
    </div>
</div>

<div class="next-day-bar" id="main-footer">
    <button class="primary-btn" style="background: #40c057;" onclick="nextDay()">ğŸŒ™ ë‹¤ìŒë‚ ë¡œ (Space)</button>
</div>

<div id="eventModal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <div id="modal-body" style="margin: 15px 0; font-size: 14px;"></div>
        <div id="modal-choices"></div>
    </div>
</div>

<script>
    function startGame() {
        document.getElementById('start-page').style.display = 'none';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('main-container').style.display = 'block';
        document.getElementById('main-footer').style.display = 'block';
        updateDisplay();
    }

    let gameState = {
        day: 1, startDate: new Date('2025-09-05'), finance: 200000000, fandom: 110000, youtube: 20000, sns: 1000,
        members: [
            {name: 'í‚¤ë§ˆ', birth: '04-22', vocal: 11, dance: 10, visual: 10, variety: 9, charm: 10, fatigue: 10, manualAct: null},
            {name: 'ëµê·¤', birth: '12-24', vocal: 11, dance: 10, visual: 10, variety: 9, charm: 10, fatigue: 10, manualAct: null},
            {name: 'ì±ˆë‚˜', birth: '02-26', vocal: 9, dance: 10, visual: 11, variety: 9, charm: 10, fatigue: 10, manualAct: null},
            {name: 'ì†œì£¼ë¨¹', birth: '11-11', vocal: 9, dance: 10, visual: 10, variety: 11, charm: 10, fatigue: 10, manualAct: null},
            {name: 'ì—°ì´ˆë¡', birth: '03-26', vocal: 11, dance: 10, visual: 10, variety: 10, charm: 10, fatigue: 10, manualAct: null},
        ],
        community: [], popupQueue: [], weeklyStats: [],
        pendingPost: null, // ì‘ì„±í•œ ê¸€ ì˜ˆì•½ ì •ë³´
        lastPostDay: -7    // ë§ˆì§€ë§‰ í¬ìŠ¤íŒ… ë‚ ì§œ (ì²«ë‚  ë°”ë¡œ ì‘ì„± ê°€ëŠ¥í•˜ë„ë¡ -7)
    };

    const ebemMsgs = ["í•˜ë°ìŠ¤ ì–˜ë„¤ëŠ” ì§„ì§œ í€„ë¦¬í‹°ê°€ ë„˜ì‚¬ë²½ì´ê¸´ í•˜ë„¤", "í‚¤ë§ˆ ê³ ìŒ ì‹¤í™”ëƒ? ì›¬ë§Œí•œ ê³µì¤‘íŒŒ ì•„ì´ëŒë³´ë‹¤ ë…¸ë˜ ì˜í•˜ëŠ”ë°", "ì˜¤ëŠ˜ ëµê·¤ ë°©ì†¡ì—ì„œ ìƒ·ê±´ ì¹˜ëŠ” ê±° ë³´ê³  ì…ë•í–ˆë‹¤ ã…‹ã…‹ã…‹", "ì†”ì§íˆ ë²„ì¶”ì–¼ì´ë¼ê³  ìƒ‰ì•ˆê²½ ê¼ˆëŠ”ë° í•˜ë°ìŠ¤ëŠ” ì¸ì •í•¨", "ì—°ì´ˆë¡ ì•„ë°”íƒ€ ë–´ê¸¸ë˜ ë´¤ëŠ”ë° ì§„ì§œ ê¹ì•„ ë†“ì€ ê²ƒ ê°™ë„¤", "ì•„ë‹ˆ ì±ˆë‚˜ ì˜ˆëŠ¥ê° ë­ì„? í•©ë°©ì—ì„œ í˜¼ì ë‹¤ ì‚´ë¦¬ë„¤ ã„¹ã…‡", "ì†œì£¼ë¨¹ì€ ì´ë¦„ë¶€í„°ê°€ ì›ƒê¸°ë„¤ ã…‹ã…‹ã…‹ íƒ€ê²©ê° ì¢‹ì„ ë“¯", "ì˜¤ëŠ˜ í•˜ë°ìŠ¤ ë¼ì´ë¸Œ MR ì œê±° ë²„ì „ ì˜¬ë¼ì™”ëŠ”ë° ì‹¤ë ¥ ì§„ì§œ ì¢‹ìŒ", "ì—ë±€ í˜•ë‹˜ë“¤ í•˜ë°ìŠ¤ êµ¿ì¦ˆ ì˜ˆêµ¬ ì„±ê³µí•œ ì‚¬ëŒ ìˆìŒ?", "ë²„ì¶”ì–¼ ì•„ì´ëŒ ì‹œì¥ë„ ì´ì œ ì‹¤ë ¥ ì—†ìœ¼ë©´ ëª» ì‚´ì•„ë‚¨ëŠ”êµ¬ë‚˜"];
    const cafeMsgs = ["ìˆ¨ìŠ¤ìˆ¨ìŠ¤", "ì‰¬ë”ë¼ë„ ìŠ¤íŠ¸ë¦¬ë°ì€ í•˜ê³ ìˆê² ì£ ?", "ì¼€ë¡œ 1ê¸° ëª¨ì—¬ë¼!", "ì˜¤ëŠ˜ë„ ë©¤ë²„ë“¤ ê³ ìƒí–ˆì–´ìš”", "ë°©ì†¡ê³µì§€ ì–¸ì œ ì˜¬ë¼ì˜¤ì§€?", "í•˜ë°ìŠ¤ ì…ë• ì™„ë£Œ"];
    const yzMsgs = ["ì˜¤ëŠ˜ ëµê·¤ ì™œ ì´ëŸ¼? ê¸°ìˆ ë ¥ ë¯¸ì³¤ë„¤ ã„¹ã…‡ #í•˜ë°ìŠ¤ #ëµê·¤", "í‚¤ë§ˆ ê³ ìŒ ë°œì‚¬í•  ë•Œ íŠ¸ë˜í‚¹ íŠ€ëŠ” ê±° ê°œì›ƒê¸°ë„¤ ã…‹ã…‹ã…‹ã…‹ ê·€ì—¬ì›Œ", "í•˜ë°ìŠ¤ ì´ë²ˆ ì‹ ê³¡ ë¬´í•œìŠ¤ë° ì¤‘.", "ì—°ì´ˆë¡ ë¹„ì£¼ì–¼ ì‹¤í™”ëƒ? 3Dê°€ ì‚¬ëŒ í™€ë¦¬ë„¤... #Hades #ì—°ì´ˆë¡"];

    const virtualEvents = [
        { id: 'server', title: "ğŸ’» ë°©ì†¡ ë ‰ ë°œìƒ", desc: "ë°©ì†¡ ì¤‘ ì¸í„°ë„·ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.", choices: [{ text: "ë°”ë¡œ êµì²´í•˜ì (-500ë§Œ/íŒ¬ë¤+2000)", effect: () => { gameState.finance -= 5000000; updateFandom(2000); } }, { text: "ì¼ë‹¨ ë°©ì¢…í•˜ì (íŒ¬ë¤-1000)", effect: () => { updateFandom(-1000); } }, { text: "ì˜¤ëŠ˜ì€ ê·¸ëƒ¥ ì§„í–‰í•´ (íŒ¬ë¤-2000)", effect: () => { updateFandom(-2000); } }] },
        { id: 'costume', title: "ğŸ‘— ì‹ ê·œ ì˜ìƒ", desc: "ê³ í€„ë¦¬í‹° ì•„ë°”íƒ€ ì˜ìƒì„ ì œì‘í• ê¹Œìš”?", choices: [{ text: "í”„ë¦¬ë¯¸ì—„ (-500ë§Œ/íŒ¬ë¤+8000)", effect: () => { gameState.finance -= 5000000; updateFandom(8000); } }, { text: "ë³´ê¸‰í˜• (-100ë§Œ/íŒ¬ë¤+2000)", effect: () => { gameState.finance -= 1000000; updateFandom(2000); } }, { text: "ì œì‘ ì•ˆí•¨", effect: () => {} }] },
        { id: 'collab', title: "ğŸŒŸ íƒ€ ìœ íŠœë²„ í•©ë°©", desc: "ëŒ€ê¸°ì—… ë²„íŠœë²„ê°€ í•©ë°©ì„ ì œì˜í–ˆìŠµë‹ˆë‹¤.", choices: [{ text: "ìœ ë£Œ ê´‘ê³  ë™ë°˜ (-500ë§Œ/íŒ¬ë¤+6000)", effect: () => { gameState.finance -= 5000000; updateFandom(6000); } }, { text: "ì¼ë°˜ ì°¸ì—¬ (íŒ¬ë¤+2500)", effect: () => { updateFandom(2500); } }, { text: "ê±°ì ˆ (ì—†ìŒ)", effect: () => {} }] }
    ];

    window.addEventListener('keydown', e => { 
        if (e.code === 'Space') {
            const modal = document.getElementById('eventModal');
            if (modal.style.display === 'block') {
                const btn = modal.querySelector('.primary-btn');
                if(btn) btn.click();
            } else { if(document.getElementById('start-page').style.display === 'none') nextDay(); }
        }
    });

    function updateFandom(val) {
        gameState.fandom = Math.max(0, gameState.fandom + val);
        gameState.youtube += Math.floor(val * 0.7);
        gameState.sns += Math.floor(val * 1.2);
    }

    function updateDisplay() {
        document.getElementById('current-day').innerText = gameState.day;
        let d = new Date(gameState.startDate); d.setDate(d.getDate() + (gameState.day - 1));
        document.getElementById('current-date').innerText = d.toISOString().split('T')[0];
        document.getElementById('p-finance').innerText = gameState.finance.toLocaleString() + 'ì›';
        document.getElementById('p-fandom').innerText = gameState.fandom.toLocaleString() + 'ëª…';
        document.getElementById('p-youtube').innerText = gameState.youtube.toLocaleString() + 'ëª…';
        document.getElementById('p-sns').innerText = gameState.sns.toLocaleString() + 'ëª…';
        
        document.getElementById('member-grid-container').innerHTML = gameState.members.map(m => `
            <div class="member-card" style="${m.fatigue >= 100 ? 'border-color:var(--danger); background:#fff5f5;' : ''}">
                <div style="display:flex; justify-content:space-between;"><strong>${m.name}</strong><span style="font-size:10px; color:#999;">ğŸ‚ ${m.birth}</span></div>
                ${renderStat('ë³´ì»¬',m.vocal,'var(--vocal)')}${renderStat('ëŒ„ìŠ¤',m.dance,'var(--dance)')}${renderStat('ë¹„ì£¼ì–¼',m.visual,'var(--visual)')}${renderStat('ì˜ˆëŠ¥',m.variety, 'var(--variety)')}${renderStat('ë§¤ë ¥',m.charm,'var(--charm)')}
                <div style="font-size:11px; text-align:right; color:${m.fatigue >= 100 ? 'var(--danger)' : '#888'};">í”¼ë¡œë„: ${m.fatigue}%</div>
            </div>
        `).join('');

        const latestComm = gameState.community.slice(-4);
        document.getElementById('comm-container').innerHTML = latestComm.map(c => `
            <div class="comm-post">
                <span class="comm-site ${c.site==='SNS'?'site-sns':(c.site==='ì—ë±€'?'site-ebem':(c.site==='ë„ˆíŠœë¸Œ'?'site-yt':(c.site==='YZ'?'site-yz':'site-cafe')))}">${c.site}</span>
                <div style="font-size:13px; margin-top:4px;">${c.content}</div>
            </div>
        `).reverse().join('');
    }

    function renderStat(l, v, c) {
        return `<div class="stat-row"><div class="stat-label">${l}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${(v/20)*100}%; background:${v>=20?'#333':c}"></div></div><div style="font-size:10px;">${v}</div></div>`;
    }

    // ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° í•¨ìˆ˜ (ì‹ ê·œ)
    function writeCommunityPost() {
        const site = document.getElementById('post-site').value;
        const content = document.getElementById('post-content').value;

        if (!content.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (gameState.day - gameState.lastPostDay < 7) {
            return alert(`ê²Œì‹œê¸€ì€ ì¼ì£¼ì¼ì— í•œ ë²ˆë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤. (ë‚¨ì€ ê¸°ê°„: ${7 - (gameState.day - gameState.lastPostDay)}ì¼)`);
        }

        const upvote = Math.floor(Math.random() * 301);
        const downvote = Math.floor(Math.random() * 101);
        let bonus = 0;
        if (upvote > 0) bonus = Math.min(500, Math.floor((upvote / 300) * 500));
        if (downvote > upvote) bonus = 0; // ë¹„ì¶”ê°€ ë” ë§ìœ¼ë©´ ë³´ë„ˆìŠ¤ 0

        gameState.pendingPost = { site, content, upvote, downvote, bonus };
        gameState.lastPostDay = gameState.day;
        document.getElementById('post-content').value = "";
        alert(`${site}ì— ê¸€ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!`);
    }

    function nextDay() {
        if (document.getElementById('eventModal').style.display === 'block') return;

        // ì˜ˆì•½ëœ ê²Œì‹œê¸€ ì²˜ë¦¬
        if (gameState.pendingPost) {
            const p = gameState.pendingPost;
            const resultMsg = `<b>[ë‚´ê°€ ì“´ ê¸€] ${p.content}</b> <br> <span style="color:var(--point)">ğŸ‘ ì¶”ì²œ ${p.upvote}</span> / <span style="color:#888;">ğŸ‘ ë¹„ì¶” ${p.downvote}</span> (íŒ¬ë¤ +${p.bonus}ëª…)`;
            gameState.community.push({ site: p.site, content: resultMsg });
            updateFandom(p.bonus);
            gameState.pendingPost = null;
        }

        let totalProfit = Math.floor(Math.random() * 600001) + 400000;
        const actionsPool = ['vocal', 'dance', 'visual', 'variety', 'charm', 'rest'];
        
        gameState.members.forEach(m => {
            let action = m.manualAct || actionsPool[Math.floor(Math.random() * actionsPool.length)];
            if (action === 'rest') { m.fatigue = Math.max(0, m.fatigue - 25); } 
            else if (m.fatigue < 100) {
                if (m[action] < 20 && Math.random() < 0.4) { 
                    m[action]++; 
                    gameState.weeklyStats.push({name: m.name, stat: action});
                    m.fatigue = Math.min(100, m.fatigue + 15); 
                } else { m.fatigue = Math.min(100, m.fatigue + 10); }
            }
            m.manualAct = null;
        });

        if(gameState.day % 7 === 0 && gameState.day > 1) {
            const views = (Math.floor(Math.random() * 291) + 10) * 10000;
            const star = gameState.members[Math.floor(Math.random()*gameState.members.length)].name;
            gameState.community.push({ site: 'ë„ˆíŠœë¸Œ', content: `ğŸ¥ <b>ì£¼ê°„ ì¸ê¸° ê¸‰ìƒìŠ¹!</b> ${star} ì¡°íšŒìˆ˜ ${views.toLocaleString()}íšŒ ë‹¬ì„±!` });
            gameState.popupQueue.push({type: 'training_report', data: [...gameState.weeklyStats]});
            gameState.weeklyStats = [];
        }

        if (Math.random() < 0.45) gameState.community.push({site:'ì—ë±€', content: ebemMsgs[Math.floor(Math.random()*ebemMsgs.length)]});
        if (Math.random() < 0.45) gameState.community.push({site:'íŒ¬ì¹´í˜', content: cafeMsgs[Math.floor(Math.random()*cafeMsgs.length)]});
        if (Math.random() < 0.45) gameState.community.push({site:'YZ', content: yzMsgs[Math.floor(Math.random()*yzMsgs.length)]});
        
        checkVirtualEvent();
        gameState.finance += totalProfit; 
        gameState.finance -= 500000; // ìœ ì§€ë¹„
        updateFandom(Math.floor(totalProfit / 10000));
        gameState.day++;
        gameState.members.forEach(m => m.fatigue = Math.max(0, m.fatigue - 10));
        
        document.getElementById('profit-report').style.display = 'block';
        document.getElementById('profit-content').innerHTML = `ìˆ˜ìµ: <span class="money-text">${totalProfit.toLocaleString()}ì›</span>`;
        updateDisplay();
        processNextPopup();
    }

    function checkVirtualEvent() {
        if (Math.random() > 0.15) return; 
        const day = gameState.day;
        let pool = ['server', 'costume', 'collab'];
        const selectedId = pool[Math.floor(Math.random() * pool.length)];
        const ev = virtualEvents.find(e => e.id === selectedId);
        if (ev) gameState.popupQueue.push({type: 'virtual', event: ev});
    }

    function processNextPopup() {
        if (document.getElementById('eventModal').style.display === 'block') return;
        if (gameState.popupQueue.length === 0) return;
        const item = gameState.popupQueue.shift();
        if(item.type === 'training_report') showTrainingReport(item.data);
        else if(item.type === 'virtual') renderEventPopup(item.event);
    }

    function renderEventPopup(ev) {
        const modal = document.getElementById('eventModal');
        document.getElementById('modal-title').innerText = ev.title;
        document.getElementById('modal-body').innerText = ev.desc;
        document.getElementById('modal-choices').innerHTML = ev.choices.map((c, idx) => `
            <button class="choice-btn" onclick="executeVirtualChoice('${ev.id}', ${idx})">${c.text}</button>
        `).join('');
        modal.style.display = 'block';
    }

    function showTrainingReport(logs) {
        const modal = document.getElementById('eventModal');
        document.getElementById('modal-title').innerText = "ğŸ—“ï¸ ì£¼ê°„ íŠ¸ë ˆì´ë‹ ê²°ì‚°";
        if (logs.length === 0) {
            document.getElementById('modal-body').innerHTML = `<div style="text-align:center; padding:15px;">ì´ë²ˆ ì£¼ëŠ” ìŠ¤íƒ¯ ë³€í™”ê°€ ì—†ì—ˆìŠµë‹ˆë‹¤.</div>`;
        } else {
            const summary = {};
            logs.forEach(l => {
                if (!summary[l.name]) summary[l.name] = [];
                const statName = {vocal:'ë³´ì»¬', dance:'ëŒ„ìŠ¤', visual:'ë¹„ì£¼ì–¼', variety:'ì˜ˆëŠ¥', charm:'ë§¤ë ¥'}[l.stat];
                summary[l.name].push(statName);
            });
            let listHtml = Object.entries(summary).map(([name, stats]) => {
                const counts = {};
                stats.forEach(s => counts[s] = (counts[s] || 0) + 1);
                const statString = Object.entries(counts).map(([s, c]) => `${s} <span style="color:var(--success); font-weight:bold;">+${c}</span>`).join(', ');
                return `<div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:6px;"><span style="color:var(--point); font-weight:bold;">${name}</span><br>${statString}</div>`;
            }).join('');
            document.getElementById('modal-body').innerHTML = `<div style="text-align:left; background:#f8f9fa; padding:15px; border-radius:10px; font-size:14px; max-height:300px; overflow-y:auto;">${listHtml}</div>`;
        }
        document.getElementById('modal-choices').innerHTML = `<button class="primary-btn" onclick="closeModal()">í™•ì¸ (Space)</button>`;
        modal.style.display = 'block';
    }

    function executeVirtualChoice(evId, chIdx) {
        const ev = virtualEvents.find(e => e.id === evId);
        ev.choices[chIdx].effect();
        closeModal();
    }

    function closeModal() { 
        document.getElementById('eventModal').style.display = 'none'; 
        setTimeout(processNextPopup, 150); 
    }

    function manualTrainAction() {
        const name = document.getElementById('sel-member').value; const stat = document.getElementById('sel-stat').value;
        const m = gameState.members.find(i => i.name === name);
        if (stat !== 'rest' && m.fatigue >= 100) return alert("í”¼ë¡œë„ ì´ˆê³¼!");
        m.manualAct = stat; alert(`${name} ì§€ì‹œ ì™„ë£Œ`); updateDisplay();
    }

    function openPage(pId, btn) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(pId).classList.add('active'); if(btn) btn.classList.add('active');
        updateDisplay();
    }

    const sel = document.getElementById('sel-member');
    gameState.members.forEach(m => sel.innerHTML += `<option value="${m.name}">${m.name}</option>`);
</script>
</body>
</html>
